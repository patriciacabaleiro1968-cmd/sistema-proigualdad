<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>ProIgualdad – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --primary:#4a3c8d; --secondary:#e5438a; --accent:#41c4b3;
      --muted:#6c757d; --paper:#ffffff; --bg:#f6f7fb;
    }
    body{ background:var(--bg); color:#2b2e34; font-family: system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue","Noto Sans",sans-serif; }
    .navbar{ background:linear-gradient(135deg,var(--primary),#6a52b3); }
    .sidebar{ background:#fff; border-right:1px solid #eceff5; height:calc(100vh - 56px); position:sticky; top:56px; padding-top:12px; }
    .sidebar .nav-link{ color:#3f4652; border-left:4px solid transparent; padding:10px 16px; }
    .sidebar .nav-link i{ color:var(--primary); margin-right:8px; }
    .sidebar .nav-link.active,.sidebar .nav-link:hover{ background:#f2f0ff; color:var(--primary); border-left-color:var(--primary); }

    .card{ border:none; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .kpi{ border-left:4px solid var(--primary); }
    .component-badge{ background:var(--primary); color:#fff; padding:4px 8px; border-radius:6px; font-size:.78rem; }
    .filter-section{ background:#fff; border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(0,0,0,.05); }
    .year-comparison{ background:linear-gradient(135deg,#667eea,#764ba2); color:#fff; border-radius:14px; padding:18px; }
    .last-update{ font-size:.85rem; color:var(--muted); }

    .dashboard-section{ display:none; }
    .dashboard-section.active{ display:block; }

    .empty-state{
      display:flex; align-items:center; justify-content:center;
      background:repeating-linear-gradient( -45deg, #fbfcff, #fbfcff 10px, #f3f5fb 10px, #f3f5fb 20px);
      border-radius:8px; border:1px dashed #d7dbea; color:#8b90a0; height:220px;
    }
    .badge-state{ font-weight:600; }
    .badge-state.bg-success{ background:#20c997!important; }
    .badge-state.bg-warning{ background:#ffc107!important; color:#212529!important; }
    .badge-state.bg-secondary{ background:#adb5bd!important; }

    .text-truncate-3{ display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical; overflow:hidden; }

    /* Mini-Gantt */
    .gantt{ width:100%; border-collapse:separate; border-spacing:0; }
    .gantt th,.gantt td{ border:1px solid #e7eaf3; padding:.35rem .5rem; font-size:.9rem; }
    .gantt thead th{ position:sticky; top:0; background:#fff; z-index:1; }
    .gantt .hit{ background:rgba(74,60,141,.12); border-color:#bfb9d9; }
  </style>
</head>
<body>
  <!-- Overlay de carga -->
  <div class="position-fixed top-0 start-0 w-100 h-100 d-none" style="background:rgba(255,255,255,.8); z-index:9999" id="loading">
    <div class="d-flex h-100 align-items-center justify-content-center flex-column">
      <div class="spinner-border text-primary" role="status"></div>
      <div class="mt-2">Cargando datos desde Google Sheets…</div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-venus-double me-2"></i> Sistema de Monitoreo – ProIgualdad</a>
      <div class="d-flex align-items-center gap-2">
        <span class="text-light small d-none d-md-inline" id="today"></span>
        <button class="btn btn-outline-light btn-sm" id="btnReload"><i class="fa-solid fa-rotate me-1"></i>Actualizar</button>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 col-md-3 p-0 sidebar">
        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="resumen"><i class="fa-solid fa-chart-pie"></i> Resumen General</a>
          <a class="nav-link" href="#" data-section="indicadores"><i class="fa-solid fa-chart-bar"></i> Indicadores</a>
          <a class="nav-link" href="#" data-section="componentes"><i class="fa-solid fa-puzzle-piece"></i> Componentes</a>
          <a class="nav-link" href="#" data-section="actividades"><i class="fa-solid fa-list-check"></i> Actividades</a>
          <a class="nav-link" href="#" data-section="cronograma"><i class="fa-solid fa-calendar-days"></i> Cronograma</a>
          <a class="nav-link" href="#" data-section="configuracion"><i class="fa-solid fa-gear"></i> Configuración</a>
        </nav>
      </div>

      <!-- Main -->
      <div class="col-lg-10 col-md-9 mt-4">
        <!-- Filtros -->
        <div class="filter-section mb-3">
          <div class="row g-3 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Año de Gestión</label>
              <select id="yearFilter" class="form-select">
                <option value="2025" selected>2025 (Actual)</option>
                <option value="2026">2026 (Próxima)</option>
                <option value="2027">2027 (Estratégica)</option>
                <option value="todos">Todos</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label">Componente</label>
              <select id="compFilter" class="form-select">
                <option value="">Todos</option>
                <option value="C1">COMPONENTE 1</option>
                <option value="C2">COMPONENTE 2</option>
                <option value="C3">COMPONENTE 3</option>
              </select>
            </div>
            <div class="col-md-4 d-flex justify-content-between">
              <div>
                <div class="small text-muted">Última actualización</div>
                <div id="lastUpdate" class="last-update">--</div>
              </div>
              <button id="btnApply" class="btn btn-primary">Aplicar Filtros</button>
            </div>
          </div>
        </div>

        <!-- ===== RESUMEN ===== -->
        <div id="resumen" class="dashboard-section active">
          <h2 class="mb-3">Resumen del Proyecto</h2>

          <div class="year-comparison mb-3">
            <div class="row text-center">
              <div class="col"><div class="h4 mb-1">2025</div><div id="p2025" class="fs-3">--%</div><small>Actual</small></div>
              <div class="col"><div class="h4 mb-1">2026</div><div id="p2026" class="fs-3">--%</div><small>Próxima</small></div>
              <div class="col"><div class="h4 mb-1">2027</div><div id="p2027" class="fs-3">--%</div><small>Estratégica</small></div>
              <div class="col"><div class="h4 mb-1">Global</div><div id="pGlobal" class="fs-2 fw-bold">--%</div><small>Total</small></div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-lg-8">
              <div class="card p-3">
                <h5>Objetivo General</h5>
                <p class="mb-2">El aporte de los actores clave en los sectores educación, empresas y medios de comunicación para el fomento de la igualdad de género y los derechos LGBTIA está fortalecido.</p>
                <div class="progress" style="height:10px">
                  <div id="barGlobal" class="progress-bar bg-success" style="width:0%"></div>
                </div>
                <small id="txtGlobal" class="text-muted">Progreso general: --%</small>
              </div>
            </div>
            <div class="col-lg-4">
              <div class="card p-3 mb-3 kpi">
                <div class="small text-muted">Metodologías institucionalizadas (1.1)</div>
                <div id="kpi11" class="fs-1">0/5</div><small>Meta: 5</small>
              </div>
              <div class="card p-3 kpi">
                <div class="small text-muted">Productos comunicacionales (3.1)</div>
                <div id="kpi31" class="fs-1">0/38</div><small id="kpi31pct">0% de avance</small>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="card p-3">
                <h6 class="mb-2">Distribución por Componente (dinámica)</h6>
                <div id="wrapDonut"><canvas id="componentChart" height="220"></canvas></div>
                <div id="emptyDonut" class="empty-state d-none">
                  <div><i class="fa-regular fa-circle-xmark me-2"></i>No hay avances para el filtro seleccionado</div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card p-3">
                <h6 class="mb-2">Evolución de Indicadores por Año</h6>
                <div id="wrapEvo"><canvas id="evolutionChart" height="220"></canvas></div>
                <div id="emptyEvo" class="empty-state d-none">
                  <div><i class="fa-regular fa-circle-xmark me-2"></i>Sin datos para graficar</div>
                </div>
                <div class="small text-muted mt-1">Sólida = Avance · Punteada = Meta</div>
              </div>
            </div>
          </div>

          <div class="card mt-3">
            <div class="card-header">
              <h6 class="mb-0"><i class="fa-solid fa-database me-2"></i>Consolidado por Indicador – <span id="titleYear">2025</span></h6>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Año</th><th>Componente</th><th>Indicador</th>
                      <th class="text-end">Meta</th><th class="text-end">Actual</th>
                      <th style="min-width:140px">Progreso</th><th>Estado</th>
                    </tr>
                  </thead>
                  <tbody id="tblInd"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== INDICADORES ===== -->
        <div id="indicadores" class="dashboard-section">
          <h2 class="mb-3">Indicadores de Desempeño</h2>
          <div class="card p-3 mb-3">
            <h6 class="mb-2">Comparativo (% de avance por indicador) – <span id="titleBars">2025</span></h6>
            <div id="wrapBars"><canvas id="barsChart" height="260"></canvas></div>
            <div id="emptyBars" class="empty-state d-none"><div><i class="fa-regular fa-circle-xmark me-2"></i>Sin datos para graficar</div></div>
            <div class="small text-muted mt-2">
              * Pasa el mouse sobre cada barra para ver el texto completo del indicador.
            </div>
          </div>
        </div>

        <!-- ===== COMPONENTES ===== -->
        <div id="componentes" class="dashboard-section">
          <h2 class="mb-3">Componentes del Proyecto</h2>
          <div class="row g-3" id="cardsComp"></div>
        </div>

        <!-- ===== ACTIVIDADES ===== -->
        <div id="actividades" class="dashboard-section">
          <h2 class="mb-3">Actividades</h2>
          <div class="card p-3">
            <div id="actInfo" class="alert alert-info d-none">
              No se detectaron columnas de actividad (se buscan: <b>Actividad_Principal</b>, <b>Actividad</b>, <b>Actividad_Princ</b>).<br/>
              Cuando existan, aquí verás el listado por mes.
            </div>
            <div id="actWrap" class="table-responsive">
              <table class="table table-hover align-middle">
                <thead class="table-light">
                  <tr><th>Mes</th><th>Actividad</th><th>Indicador</th><th class="text-end">Meta</th><th class="text-end">Actual</th><th>%</th></tr>
                </thead>
                <tbody id="tblAct"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ===== CRONOGRAMA ===== -->
        <div id="cronograma" class="dashboard-section">
          <h2 class="mb-3">Cronograma (Mini-Gantt)</h2>
          <div class="card p-3">
            <div id="ganttInfo" class="alert alert-info d-none">Para mostrar el cronograma, agrega una columna de actividad y una columna de <b>Mes</b> (Enero… Diciembre).</div>
            <div class="table-responsive">
              <table class="gantt table-sm" id="tblGantt"></table>
            </div>
          </div>
        </div>

        <!-- ===== CONFIG ===== -->
        <div id="configuracion" class="dashboard-section">
          <h2 class="mb-3">Configuración</h2>
          <div class="alert alert-info">Aquí puedes ajustar el ID de la hoja (<b>SHEET_ID</b>) y la pestaña (<b>SHEET_NAME</b>) en el código.</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ==================== CONFIG ==================== */
    // ⚠️ Cambia SOLO este ID si tu hoja es otra (y SHEET_NAME si la pestaña tiene otro nombre)
    const SHEET_ID   = '12BUwefZ4ZTHkNChkZtJlp9aD5dwrpOLPnVecytapt68';
    const SHEET_NAME = 'DATOS_JERARQUIA';
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

    const COMPONENTES = {
      C1:'COMPONENTE 1: Principios de igualdad de género y derechos LGBTIA son aplicados en la práctica docente de docentes con niños/as, adolescentes y madres/padres en las escuelas de educación primaria y secundaria y en los planes curriculares de las escuelas/unidades para la capacitación o formación continua de docentes.',
      C2:'COMPONENTE 2: La aplicación de estándares de igualdad de género y derechos LGBTIA en las empresas está fortalecida.',
      C3:'COMPONENTE 3: Las competencias de actores de medios de comunicación y de las instituciones públicas relevantes para la elaboración de productos mediáticos y comunicacionales para el fomento de la igualdad de género y los derechos LGBTIA están fortalecidas'
    };
    const INDICADORES = {
      '1.1':'Indicador 1.1: 5 metodologías educativas para el fomento de la igualdad de género y los derechos LGBTIA con niños/as, adolescentes y padres y madres de familia en 2 escuelas primarias y secundarias por cada uno de los 3 departamentos fueron piloteadas.',
      '1.2':'Indicador 1.2: 6 instrumentos de capacitación o formación continua que fomentan la igualdad de género y los derechos LGBTIA fueron piloteadas en los planes curriculares de las escuelas/unidades para la capacitación y formación continua del personal docente.',
      '2.1':'Indicador 2.1: El pilotaje de 1 instrumento de implementación ampliado por el fomento de la igualdad de género y los derechos LGBTIQA+ en 4 empresas (2 de ellas privadas y V.R.G. 2 públicas) concluyó exitosamente en 1 empresa pública y 1 empresa privada.',
      '2.2':'Indicador 2.2: 5 buenas prácticas para la aplicación de estándares de igualdad de género y derechos LGBTIQA+ son compartidas entre empresas públicas y privadas a través de una plataforma conjunta interactiva.',
      '3.1':'Indicador 3.1: 38 productos mediáticos para sensibilizar al público a nivel local, departamental y nacional en general para la igualdad de género y los derechos LGBTIA han sido elaborados por actores de medios de comunicación.',
      '3.2':'Indicador 3.2: 3 productos comunicacionales para la orientación de servidores/as de instituciones públicas en la aplicación de leyes vigentes en materia de igualdad de género y los derechos LGBTIA han sido elaborados por instituciones públicas relevantes.'
    };
    const METAS_FIJAS = {'1.1':5,'1.2':6,'2.1':1,'2.2':5,'3.1':38,'3.2':3};
    const IND_A_COMP  = {'1.1':'C1','1.2':'C1','2.1':'C2','2.2':'C2','3.1':'C3','3.2':'C3'};

    /* ==================== STATE ==================== */
    let rows=[], agg={};
    const $ = s => document.querySelector(s);
    const fmt = n => (isFinite(n)? Intl.NumberFormat('es-BO').format(n):'-');
    const pct = (a,m)=> m>0 ? Math.round((a/m)*100) : 0;
    const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const monthIdx = m => {
      const i = MONTHS.findIndex(x => x.toLowerCase() === String(m||'').toLowerCase());
      return i>=0? i : -1;
    };

    /* ==================== CSV PARSER ==================== */
    const csvToArray = (text)=>{
      const out=[]; let row=[], cur='', q=false;
      for(let i=0;i<text.length;i++){
        const ch=text[i];
        if(q){
          if(ch=='"'){
            if(text[i+1]=='"'){ cur+='"'; i++; } else q=false;
          } else cur+=ch;
        }else{
          if(ch=='"') q=true;
          else if(ch==','){ row.push(cur); cur=''; }
          else if(ch=='\n'){ row.push(cur); out.push(row); row=[]; cur=''; }
          else if(ch=='\r'){}
          else cur+=ch;
        }
      }
      if(cur.length || row.length){ row.push(cur); out.push(row); }
      return out;
    };
    const parseNum = v => {
      if (v===null||v===undefined) return 0;
      const n = parseFloat(String(v).replace(/[%\s]/g,'').replace(',','.'));
      return isNaN(n)?0:n;
    };

    // ---------- Mapeo de columnas ----------
    const colMap = (header)=>{
      const norm = s => String(s||'').trim().toLowerCase();
      const h = header.map(norm);
      const find = keys => h.findIndex(c => keys.some(k => c.includes(k)));

      const idx = {
        anio: find(['año','anio','gestión','gestion']),
        mes : find(['mes']),
        comp: find(['componente']),
        ind : find(['indicador']),
        meta: find(['meta','meta total','meta_global','meta anual']),
        act : find(['actual','avance','logro','realizado','producido','alcanzado']),
        pct : find(['%_cumpl','porcentaje_cumpl','% cumplimiento','%cumpl','porcentaje de cumplimiento','porcentaje_cumplimiento','porcentaje cumplimiento','porcentaje']),
        actName: find(['actividad_principal','actividad_princ','actividad principal','actividad'])
      };
      return idx;
    };

    const indPrefix = name=>{
      const m = String(name||'').match(/^\s*([1-3]\.[1-2])/);
      return m? m[1] : null;
    };

    /* ==================== LOAD ==================== */
    async function load(){
      $('#loading').classList.remove('d-none');
      try{
        const res = await fetch(CSV_URL,{cache:'no-store'});
        if(!res.ok) throw new Error('No se pudo leer la hoja publicada.');
        const csv = await res.text();
        const arr = csvToArray(csv);
        if(arr.length<=1) throw new Error('Hoja vacía.');

        const header = arr[0], c = colMap(header);
        rows = arr.slice(1).map(r=>({
          y: (r[c.anio]||'').toString().replace(/[^\d]/g,''),
          mes: (r[c.mes]||'').toString().trim(),
          comp: (r[c.comp]||'').trim(),
          ind:  (r[c.ind]||'').trim(),
          m: parseNum(r[c.meta]),
          a: parseNum(r[c.act]),
          p: c.pct>=0 ? parseNum(r[c.pct]) : 0,
          actName: c.actName>=0 ? (r[c.actName]||'').toString().trim() : ''
        }));
      }catch(e){
        console.warn('Fallo carga, usando ejemplo:', e);
        rows = [
          {y:'2025',mes:'Febrero',comp:'C1',ind:'1.1 Metodologías',m:5,a:0,p:40,actName:'Socializar línea base'},
          {y:'2025',mes:'Junio',comp:'C2',ind:'2.2 Buenas prácticas',m:5,a:0,p:40,actName:'Recopilar casos'},
          {y:'2025',mes:'Septiembre',comp:'C3',ind:'3.1 Productos',m:38,a:0,p:26,actName:'Producción cápsulas'}
        ];
      }finally{
        buildAgg(); renderAll();
        $('#lastUpdate').textContent = new Date().toLocaleTimeString('es-ES');
        $('#loading').classList.add('d-none');
      }
    }

    // ---------- Consolidado
    function buildAgg(){
      agg = {};
      rows.forEach(r=>{
        const pfx = indPrefix(r.ind);
        if(!pfx) return;
        if(!agg[r.y]) agg[r.y] = {};
        if(!agg[r.y][pfx]) agg[r.y][pfx] = {m:0, a:0, pct:0};

        // meta mayor
        if ((r.m||0) > agg[r.y][pfx].m) agg[r.y][pfx].m = (r.m||0);
        // % máximo
        if ((r.p||0) > agg[r.y][pfx].pct) agg[r.y][pfx].pct = (r.p||0);
        // respaldo si no hay %
        agg[r.y][pfx].a += (r.p>0 ? 0 : (r.a||0));
      });

      // derivar "a" desde % si existe
      Object.keys(agg).forEach(y=>{
        Object.keys(agg[y]).forEach(pfx=>{
          if (agg[y][pfx].pct>0){
            const meta = agg[y][pfx].m || METAS_FIJAS[pfx] || 0;
            agg[y][pfx].a = Math.round( meta * (agg[y][pfx].pct/100) );
          }
        });
      });

      // rellenar
      ['2025','2026','2027'].forEach(y=>{
        if(!agg[y]) agg[y]={};
        Object.keys(METAS_FIJAS).forEach(p=>{
          if(!agg[y][p]) agg[y][p] = {m:METAS_FIJAS[p], a:0, pct:0};
          if(!agg[y][p].m) agg[y][p].m = METAS_FIJAS[p];
        });
      });
    }

    /* ==================== RENDER ==================== */
    let charts={donut:null,evo:null,bars:null};
    const sumMeta   = (years,p)=> years.reduce((t,y)=> t+(agg[y]?.[p]?.m||METAS_FIJAS[p]||0),0);
    const sumActual = (years,p)=> years.reduce((t,y)=> t+(agg[y]?.[p]?.a||0),0);

    function renderAll(){
      const year = $('#yearFilter').value;
      const compSel = $('#compFilter').value;
      $('#titleYear').textContent   = year==='todos'?'2025–2027':year;
      $('#titleBars').textContent   = year==='todos'?'2025–2027':year;

      renderKPIs(year);
      renderDonut(year);
      renderEvolution();
      renderTable(year, compSel);
      renderBars(year, compSel);
      renderCompCards();
      renderActivities(year, compSel);
      renderGantt(year, compSel);
    }

    function renderKPIs(year){
      const ys = (year==='todos')? ['2025','2026','2027'] : [year];

      const m11 = sumMeta(ys,'1.1'), a11 = sumActual(ys,'1.1');
      const m31 = sumMeta(ys,'3.1'), a31 = sumActual(ys,'3.1');
      $('#kpi11').textContent = `${a11}/${m11}`;
      $('#kpi31').textContent = `${a31}/${m31}`;
      $('#kpi31pct').textContent = `${pct(a31,m31)}% de avance`;

      // Global
      let MG=0, AG=0; Object.keys(METAS_FIJAS).forEach(p=>{ MG+=sumMeta(ys,p); AG+=sumActual(ys,p); });
      const g = pct(AG,MG);
      $('#barGlobal').style.width = `${g}%`;
      $('#txtGlobal').textContent = `Progreso general: ${g}%`;
      // Por año
      const ya = y=>{ let m=0,a=0; Object.keys(METAS_FIJAS).forEach(p=>{m+=sumMeta([y],p); a+=sumActual([y],p)}); return pct(a,m); };
      $('#p2025').textContent = `${ya('2025')}%`;
      $('#p2026').textContent = `${ya('2026')}%`;
      $('#p2027').textContent = `${ya('2027')}%`;
      $('#pGlobal').textContent = `${g}%`;
    }

    function renderDonut(year){
      const ys = (year==='todos')? ['2025','2026','2027'] : [year];
      const C = {C1:0,C2:0,C3:0};
      Object.keys(INDICADORES).forEach(p=>{ const c=IND_A_COMP[p]; C[c]+=sumActual(ys,p); });
      const total = C.C1 + C.C2 + C.C3;

      if (charts.donut){ charts.donut.destroy(); charts.donut=null; }
      if (total===0){
        $('#wrapDonut').classList.add('d-none'); $('#emptyDonut').classList.remove('d-none'); return;
      }
      $('#emptyDonut').classList.add('d-none'); $('#wrapDonut').classList.remove('d-none');

      charts.donut = new Chart($('#componentChart'),{
        type:'doughnut',
        data:{ labels:['C1','C2','C3'], datasets:[{ data:[C.C1,C.C2,C.C3], backgroundColor:['#4a3c8d','#28a745','#17a2b8'], borderWidth:0 }]},
        options:{ responsive:true, plugins:{ legend:{position:'bottom'} } }
      });
    }

    function renderEvolution(){
      const years = ['2025','2026','2027'];
      const m11 = years.map(y=> agg[y]['1.1']?.m || METAS_FIJAS['1.1']);
      const a11 = years.map(y=> agg[y]['1.1']?.a || 0);
      const m31 = years.map(y=> agg[y]['3.1']?.m || METAS_FIJAS['3.1']);
      const a31 = years.map(y=> agg[y]['3.1']?.a || 0);
      const allZero = [...a11,...a31].every(v=>v===0);

      if (charts.evo){ charts.evo.destroy(); charts.evo=null; }
      if (allZero){
        $('#wrapEvo').classList.add('d-none'); $('#emptyEvo').classList.remove('d-none'); return;
      }
      $('#emptyEvo').classList.add('d-none'); $('#wrapEvo').classList.remove('d-none');

      charts.evo = new Chart($('#evolutionChart'),{
        type:'line',
        data:{
          labels:years,
          datasets:[
            {label:'Metodologías - Avance', data:a11, borderColor:'#4a3c8d', backgroundColor:'rgba(74,60,141,.08)', tension:.2},
            {label:'Metodologías - Meta',    data:m11, borderDash:[6,6], borderColor:'#4a3c8d', pointRadius:0},
            {label:'Productos - Avance',     data:a31, borderColor:'#e5438a', backgroundColor:'rgba(229,67,138,.08)', tension:.2},
            {label:'Productos - Meta',       data:m31, borderDash:[6,6], borderColor:'#e5438a', pointRadius:0}
          ]
        },
        options:{ responsive:true, interaction:{mode:'index',intersect:false}, scales:{y:{beginAtZero:true}} }
      });
    }

    function renderTable(year, compSel){
      const tb = $('#tblInd'); tb.innerHTML='';
      const ys = (year==='todos')? ['2025','2026','2027'] : [year];
      const order=['1.1','1.2','2.1','2.2','3.1','3.2'];
      order.forEach(p=>{
        const comp=IND_A_COMP[p]; if(compSel && compSel!==comp) return;
        const m=sumMeta(ys,p), a=sumActual(ys,p), pc=pct(a,m);
        const estado = pc>=100?'Completado': pc>0?'En progreso':'No iniciado';
        const badge = pc>=100?'success': pc>0?'warning':'secondary';
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${year==='todos'?'2025–2027':year}</td>
          <td><span class="component-badge">${comp}</span> ${COMPONENTES[comp]}</td>
          <td class="text-truncate-3" style="max-width:540px">${INDICADORES[p]}</td>
          <td class="text-end">${fmt(m)}</td>
          <td class="text-end">${fmt(a)}</td>
          <td>
            <div class="progress" style="height:10px"><div class="progress-bar" style="width:${pc}%"></div></div>
            <small class="text-muted">${pc}%</small>
          </td>
          <td><span class="badge badge-state bg-${badge}">${estado}</span></td>
        `;
        tb.appendChild(tr);
      });
    }

    // === Indicadores (barras) con filtro por componente y etiquetas legibles
    function renderBars(year, compSel){
      const ys = (year==='todos')? ['2025','2026','2027'] : [year];
      const order=['1.1','1.2','2.1','2.2','3.1','3.2'];
      const keys = order.filter(k => !compSel || IND_A_COMP[k]===compSel);

      // etiquetas cortas
      const short = {
        '1.1':'1.1 Metodologías',
        '1.2':'1.2 Instrumentos',
        '2.1':'2.1 Sello ampliado',
        '2.2':'2.2 Buenas prácticas',
        '3.1':'3.1 Productos mediáticos',
        '3.2':'3.2 Productos comunicacionales'
      };

      const labels = keys.map(k=> short[k]);
      const labelsFull = keys.map(k=> INDICADORES[k]); // para tooltip
      const values = keys.map(k=> pct(sumActual(ys,k), sumMeta(ys,k)));
      const allZero = values.every(v=> v===0);

      if (charts.bars){ charts.bars.destroy(); charts.bars=null; }
      if (allZero || labels.length===0){ $('#wrapBars').classList.add('d-none'); $('#emptyBars').classList.remove('d-none'); return; }
      $('#emptyBars').classList.add('d-none'); $('#wrapBars').classList.remove('d-none');

      charts.bars = new Chart($('#barsChart'),{
        type:'bar',
        data:{ labels, datasets:[{ label:'% de avance', data: values }]},
        options:{
          responsive:true, indexAxis:'y',
          scales:{ x:{ beginAtZero:true, max:100, ticks:{ callback:v=> v+'%' } } },
          plugins:{
            legend:{ display:false },
            tooltip:{
              callbacks:{
                title:(ctx)=> labelsFull[ctx[0].dataIndex],
                label:(ctx)=> `Avance: ${ctx.raw}%`
              }
            }
          }
        }
      });
    }

    function renderCompCards(){
      const cont = $('#cardsComp'); cont.innerHTML='';
      ['C1','C2','C3'].forEach(c=>{
        const li = Object.entries(INDICADORES).filter(([k])=> IND_A_COMP[k]===c)
          .map(([k,v])=> `<li class="mb-1">${v}</li>`).join('');
        cont.insertAdjacentHTML('beforeend', `
          <div class="col-12">
            <div class="card p-3">
              <div class="d-flex">
                <div class="me-3"><span class="component-badge">${c}</span></div>
                <div><h6 class="mb-2">${COMPONENTES[c]}</h6><ul class="mb-0">${li}</ul></div>
              </div>
            </div>
          </div>
        `);
      });
    }

    // === Actividades (si hay columnas)
    function renderActivities(year, compSel){
      const tb = $('#tblAct'); tb.innerHTML='';
      const info = $('#actInfo'); info.classList.add('d-none');

      // detectar columnas: ya mapeamos actName y mes
      const hasAct = rows.some(r=> r.actName);
      const hasMes = rows.some(r=> monthIdx(r.mes)>=0);
      if (!hasAct || !hasMes){
        info.classList.remove('d-none'); return;
      }

      const ys = (year==='todos')? ['2025','2026','2027'] : [year];
      const filtered = rows.filter(r=>{
        if (!ys.includes(r.y)) return false;
        if (compSel && r.comp!==compSel) return false;
        return !!r.actName && monthIdx(r.mes)>=0;
      });

      // ordenar por mes
      filtered.sort( (a,b)=> monthIdx(a.mes)-monthIdx(b.mes) );

      filtered.forEach(r=>{
        const pfx = indPrefix(r.ind);
        const m = r.m || METAS_FIJAS[pfx] || 0;
        // tomar % si existe
        const act = (r.p>0 && m>0) ? Math.round(m*(r.p/100)) : (r.a||0);
        const per = pct(act,m);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.mes}</td>
          <td>${r.actName}</td>
          <td>${pfx || ''}</td>
          <td class="text-end">${fmt(m)}</td>
          <td class="text-end">${fmt(act)}</td>
          <td>${per}%</td>
        `;
        tb.appendChild(tr);
      });

      if (tb.children.length===0){
        tb.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Sin registros para el filtro aplicado.</td></tr>`;
      }
    }

    // === Mini-Gantt
    function renderGantt(year, compSel){
      const tbl = $('#tblGantt'); tbl.innerHTML='';
      const info = $('#ganttInfo'); info.classList.add('d-none');

      const hasAct = rows.some(r=> r.actName);
      const hasMes = rows.some(r=> monthIdx(r.mes)>=0);
      if (!hasAct || !hasMes){ info.classList.remove('d-none'); return; }

      const ys = (year==='todos')? ['2025','2026','2027'] : [year];
      const filtered = rows.filter(r=>{
        if (!ys.includes(r.y)) return false;
        if (compSel && r.comp!==compSel) return false;
        return !!r.actName && monthIdx(r.mes)>=0;
      });

      // Agrupar por actividad principal
      const map = new Map();
      filtered.forEach(r=>{
        const key = r.actName.trim();
        if(!map.has(key)) map.set(key, new Set());
        map.get(key).add( monthIdx(r.mes) );
      });

      // cabeza
      let thead = `<thead><tr><th style="min-width:280px">Actividad</th>${MONTHS.map(m=>`<th class="text-center">${m.slice(0,3)}</th>`).join('')}</tr></thead>`;
      let tbody = '<tbody>';
      for (const [act, set] of map.entries()){
        tbody += `<tr><td>${act}</td>`+ MONTHS.map((_,i)=> `<td class="${set.has(i)?'hit':''}"></td>`).join('') +`</tr>`;
      }
      if (map.size===0){
        tbody += `<tr><td colspan="13" class="text-center text-muted">Sin registros para el filtro aplicado.</td></tr>`;
      }
      tbody += '</tbody>';
      tbl.innerHTML = thead + tbody;
    }

    /* ==================== NAV / INIT ==================== */
    function setupNav(){
      document.querySelectorAll('.sidebar .nav-link').forEach(a=>{
        a.addEventListener('click',e=>{
          e.preventDefault();
          document.querySelectorAll('.sidebar .nav-link').forEach(x=>x.classList.remove('active'));
          a.addEventListener('blur',()=>a.classList.remove('active'));
          a.classList.add('active');
          const id=a.getAttribute('data-section');
          document.querySelectorAll('.dashboard-section').forEach(s=>s.classList.remove('active'));
          $('#'+id).classList.add('active');
        });
      });
    }

    document.addEventListener('DOMContentLoaded',()=>{
      $('#today').textContent = new Date().toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});
      setupNav();
      $('#btnApply').addEventListener('click', renderAll);
      $('#btnReload').addEventListener('click', load);
      load();
    });
  </script>
</body>
</html>
