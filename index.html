<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Monitoreo - ProIgualdad</title>

  <!-- Estilos / Librerías -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <!-- Gráficos / Exportación -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- Parser CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --primary:#4a3c8d; --secondary:#e5438a; --accent:#41c4b3; --light:#f8f9fa; --dark:#343a40; }
    body{ font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f5f7f9; color:#333; }
    .navbar{ background:linear-gradient(135deg,var(--primary),#6a52b3); }
    .sidebar{ background:#fff; border-right:1px solid #dee2e6; height:calc(100vh - 56px); position:sticky; top:56px; padding-top:20px; box-shadow:0 0 15px rgba(0,0,0,0.05);}
    .sidebar .nav-link{ color:var(--dark); border-left:4px solid transparent; padding:12px 20px; margin:5px 0; transition:.3s;}
    .sidebar .nav-link:hover,.sidebar .nav-link.active{ background:rgba(74,60,141,.1); border-left-color:var(--primary); color:var(--primary);}
    .sidebar .nav-link i{ margin-right:10px; color:var(--primary);}
    .card{ border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.05); border:none; transition:transform .3s;}
    .card:hover{ transform:translateY(-5px);}
    .progress{ height:10px; border-radius:5px;}
    .kpi-card{ border-left:4px solid var(--primary);}
    .btn-primary{ background:var(--primary); border-color:var(--primary);}
    .btn-primary:hover{ background:#3a2c70; border-color:#3a2c70;}
    .dashboard-section{ display:none; }
    .dashboard-section.active{ display:block; }
    .filter-section{ background:#fff; padding:15px; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05);}
    .loading-overlay{ position:fixed; inset:0; background:rgba(255,255,255,.8); display:flex; justify-content:center; align-items:center; z-index:9999;}
    .spinner-border{ width:3rem; height:3rem;}
    .data-card{ border-left:4px solid var(--accent);}
    .last-update{ font-size:.8rem; color:#6c757d; }
    .component-badge{ background:var(--primary); color:#fff; padding:3px 8px; border-radius:4px; font-size:.8rem; margin-right:5px;}
    .year-comparison{ background:linear-gradient(135deg,#667eea 0%, #764ba2 100%); color:#fff; border-radius:10px; padding:15px; margin-bottom:20px;}
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando datos…</span></div>
      <p class="mt-3">Cargando datos desde Google Sheets…</p>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fas fa-venus-double"></i> Sistema de Monitoreo - ProIgualdad</a>
      <div class="d-flex align-items-center">
        <span class="text-light me-3" id="currentDate"></span>
        <button id="btnRefresh" class="btn btn-outline-light btn-sm me-2">
          <i class="fas fa-sync-alt"></i> Actualizar
        </button>
        <div class="dropdown">
          <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-download"></i> Exportar Reporte
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="btnPDF"><i class="fas fa-file-pdf"></i> PDF</a></li>
            <li><a class="dropdown-item" href="#" id="btnExcel"><i class="fas fa-file-excel"></i> Excel</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 col-md-3 p-0 sidebar">
        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="resumen"><i class="fas fa-chart-pie"></i> Resumen General</a>
          <a class="nav-link" href="#" data-section="indicadores"><i class="fas fa-chart-line"></i> Indicadores</a>
          <a class="nav-link" href="#" data-section="componentes"><i class="fas fa-puzzle-piece"></i> Componentes</a>
          <a class="nav-link" href="#" data-section="actividades"><i class="fas fa-tasks"></i> Actividades</a>
          <a class="nav-link" href="#" data-section="calendario"><i class="fas fa-calendar-alt"></i> Cronograma</a>
          <a class="nav-link" href="#" data-section="productos"><i class="fas fa-box-open"></i> Productos</a>
          <a class="nav-link" href="#" data-section="configuracion"><i class="fas fa-cog"></i> Configuración</a>
        </nav>
      </div>

      <!-- Main Content -->
      <div class="col-lg-10 col-md-9 mt-4">
        <!-- Filtros -->
        <div class="filter-section mb-4">
          <div class="row align-items-center g-3">
            <div class="col-md-3">
              <label for="yearFilter" class="form-label">Año de Gestión</label>
              <select class="form-select" id="yearFilter">
                <option value="2025">2025 (Actual)</option>
                <option value="2024">2024 (Histórico)</option>
                <option value="2026">2026 (Próxima)</option>
                <option value="2027">2027 (Estratégica)</option>
                <option value="todos">Todos los años</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="componenteFilter" class="form-label">Componente</label>
              <select class="form-select" id="componenteFilter">
                <option value="">Todos los componentes</option>
                <option value="1">Componente 1: Educación</option>
                <option value="2">Componente 2: Empresas</option>
                <option value="3">Componente 3: Medios</option>
                <option value="4">Componente 4: Gestión</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="estadoFilter" class="form-label">Estado</label>
              <select class="form-select" id="estadoFilter">
                <option value="">Todos los estados</option>
                <option value="no-iniciado">No iniciado</option>
                <option value="en-progreso">En progreso</option>
                <option value="completado">Completado</option>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-primary w-100" id="btnFiltrar">Aplicar Filtros</button>
            </div>
          </div>
          <div class="mt-2 last-update" id="lastUpdate">Última actualización: --</div>
        </div>

        <!-- Resumen General -->
        <div id="resumen" class="dashboard-section active">
          <h2 class="mb-4">Resumen del Proyecto ProIgualdad</h2>

          <div class="year-comparison">
            <h5><i class="fas fa-calendar-alt"></i> Comparación entre Años</h5>
            <div class="row">
              <div class="col-md-3 text-center"><h3>2024</h3><h4>65%</h4><small>Histórico</small></div>
              <div class="col-md-3 text-center"><h3>2025</h3><h4 id="miniProgresoActual">35%</h4><small>Actual</small></div>
              <div class="col-md-3 text-center"><h3>2026</h3><h4>15%</h4><small>Próxima</small></div>
              <div class="col-md-3 text-center"><h3>Total</h3><h4>42%</h4><small>Global</small></div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-8">
              <div class="card"><div class="card-body">
                <h5 class="card-title">Objetivo General</h5>
                <p class="card-text">El aporte de los actores clave en los sectores educación, empresas y medios de comunicación para el fomento de la igualdad de género y los derechos LGBTIA está fortalecido.</p>
                <div class="progress mb-3"><div class="progress-bar bg-success" role="progressbar" id="progresoGeneral" style="width: 35%" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100"></div></div>
                <small id="textoProgreso">Progreso general: 35%</small>
              </div></div>
            </div>
            <div class="col-md-4">
              <div class="card kpi-card"><div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Metodologías Institucionalizadas</h6>
                <h2 class="card-title" style="color:#e5438a;" id="metodologiasInstitucionalizadas">0/5</h2>
                <p class="card-text">Meta: 5 metodologías en 3 DDE</p>
              </div></div>
              <div class="card kpi-card mt-3"><div class="card-body text-center">
                <h6 class="card-subtitle mb-2 text-muted">Productos Comunicacionales</h6>
                <h2 class="card-title" style="color:#41c4b3;" id="productosComunicacionales">0/38</h2>
                <p class="card-text" id="avanceProductos">0% de avance</p>
              </div></div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="card"><div class="card-body">
                <h5 class="card-title">Distribución por Componente (2025)</h5>
                <canvas id="componentChart" height="250"></canvas>
              </div></div>
            </div>
            <div class="col-md-6">
              <div class="card"><div class="card-body">
                <h5 class="card-title">Evolución de Indicadores por Año</h5>
                <canvas id="evolutionChart" height="250"></canvas>
              </div></div>
            </div>
          </div>

          <!-- Tabla -->
          <div class="row mt-4">
            <div class="col-12">
              <div class="card data-card">
                <div class="card-header"><h5 class="card-title"><i class="fas fa-database"></i> Datos en Tiempo Real desde Google Sheets - Año 2025</h5></div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablaDatos">
                      <thead>
                        <tr>
                          <th>Año</th>
                          <th>Componente</th>
                          <th>Indicador</th>
                          <th>Meta</th>
                          <th>Actual</th>
                          <th>Progreso</th>
                          <th>Estado</th>
                        </tr>
                      </thead>
                      <tbody><!-- se rellena por JS --></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Indicadores (gráfico comparativo) -->
        <div id="indicadores" class="dashboard-section">
          <h2 class="mb-4">Indicadores de Desempeño</h2>
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="small text-muted">Porcentaje de avance por indicador (filtrado por Año/Componente/Estado)</div>
                <button class="btn btn-sm btn-outline-secondary" id="btnIndicadoresCSV">
                  <i class="fa-solid fa-file-arrow-down"></i> Descargar CSV
                </button>
              </div>
              <div style="height:380px;">
                <canvas id="indicadoresChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Otras secciones “placeholder” -->
        <div id="componentes" class="dashboard-section"><h2 class="mb-4">Componentes del Proyecto</h2><div class="alert alert-info"><i class="fas fa-info-circle"></i> Esta sección se cargará con datos desde Google Sheets.</div></div>
        <div id="actividades" class="dashboard-section"><h2 class="mb-4">Actividades</h2><div class="alert alert-info"><i class="fas fa-info-circle"></i> Esta sección se cargará con datos desde Google Sheets.</div></div>
        <div id="calendario" class="dashboard-section"><h2 class="mb-4">Cronograma</h2><div class="alert alert-info"><i class="fas fa-info-circle"></i> Esta sección se cargará con datos desde Google Sheets.</div></div>
        <div id="productos" class="dashboard-section"><h2 class="mb-4">Productos</h2><div class="alert alert-info"><i class="fas fa-info-circle"></i> Esta sección se cargará con datos desde Google Sheets.</div></div>
        <div id="configuracion" class="dashboard-section"><h2 class="mb-4">Configuración</h2><div class="alert alert-info"><i class="fas fa-info-circle"></i> Esta sección permitirá configurar la conexión con Google Sheets.</div></div>
      </div>
    </div>
  </div>

  <!-- JS Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Lógica del dashboard -->
  <script>
    // ===== Config =====
    let componentChart, evolutionChart, indicadoresChart;
    let datosGoogleSheets = { _rows: [] };

    // Ajusta estos valores si cambiaste de hoja
    const SHEET_ID  = '12BUwefZ4ZTHkNChkZtJlp9aD5dwrpOLPnVecytapt68';
    const SHEET_GID = '0'; // <-- cambia si tu pestaña DATOS_JERARQUIA tiene otro gid

    // Acceso directo a columnas normalizadas
    const getYear     = (r) => String(r.Anio_Gestion || '').trim();
    const getComp     = (r) => String(r.Componente || '').trim();
    const getIndic    = (r) => String(r.Indicador || '').trim();
    const getMeta     = (r) => Number(r.Meta || 0);
    const getAvance   = (r) => Number(r.Avance || 0);
    const getPctCumpl = (r) => {
      const n = (r.Porcentaje_Cumplimiento ?? '').toString().replace('%','').replace(',','.');
      return n ? Number(n) : null;
    };
    const getEstado   = (r) => String(r.Estado || '').trim();

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});
      configurarNavegacion();
      inicializarGraficos();
      // Listeners UI
      document.getElementById('btnRefresh').addEventListener('click', cargarDatosDesdeSheet);
      document.getElementById('btnFiltrar').addEventListener('click', () => { aplicarFiltros(); if (isIndicadoresActive()) renderIndicadoresChart(); });
      document.getElementById('btnPDF').addEventListener('click', descargarPDF);
      document.getElementById('btnExcel').addEventListener('click', descargarExcel);
      document.getElementById('btnIndicadoresCSV')?.addEventListener('click', descargarIndicadoresCSV);
      // Carga inicial
      cargarDatosDesdeSheet();
    });

    function isIndicadoresActive(){
      return document.querySelector('.dashboard-section.active')?.id === 'indicadores';
    }

    function configurarNavegacion(){
      document.querySelectorAll('.nav-link').forEach(link=>{
        link.addEventListener('click',(e)=>{
          e.preventDefault();
          document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
          link.classList.add('active');
          document.querySelectorAll('.dashboard-section').forEach(s=>s.classList.remove('active'));
          const sectionId = link.getAttribute('data-section');
          document.getElementById(sectionId)?.classList.add('active');
          if(sectionId === 'indicadores'){ renderIndicadoresChart(); }
        });
      });
    }

    function inicializarGraficos(){
      const c1 = document.getElementById('componentChart')?.getContext('2d');
      if(c1){
        componentChart = new Chart(c1,{
          type:'doughnut',
          data:{ labels:['Educación','Empresas','Medios','Gestión'], datasets:[{ data:[35,25,20,20], backgroundColor:['#4a3c8d','#28a745','#17a2b8','#6c757d'], borderWidth:0 }] },
          options:{ responsive:true, plugins:{ legend:{ position:'bottom' } } }
        });
      }
      const c2 = document.getElementById('evolutionChart')?.getContext('2d');
      if(c2){
        evolutionChart = new Chart(c2,{
          type:'line',
          data:{ labels:['2024','2025 (Actual)','2026 (Próx)','2027 (Estrat)'],
            datasets:[
              { label:'Metodologías Institucionalizadas', data:[3,2,0,0], borderColor:'#4a3c8d', backgroundColor:'rgba(74,60,141,0.1)', fill:true },
              { label:'Productos Comunicacionales', data:[8,10,0,0], borderColor:'#e5438a', backgroundColor:'rgba(229,67,138,0.1)', fill:true }
            ]},
          options:{ responsive:true, scales:{ y:{ beginAtZero:true, title:{display:true,text:'Cantidad'} } } }
        });
      }
    }

    // ========== Carga Google Sheets ==========
    async function cargarDatosDesdeSheet(){
      mostrarLoading(true);
      try{
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${encodeURIComponent(SHEET_GID)}`;
        const resp = await fetch(url, { headers:{ 'Cache-Control':'no-cache' } });
        if(!resp.ok) throw new Error('No se pudo leer Google Sheets');
        const csvRaw = await resp.text();
        const csv = csvRaw.replace(/\r\n/g, '\n').replace(/^\uFEFF/, '');

        const parsed = Papa.parse(csv,{ header:true, skipEmptyLines:'greedy' });
        const realErrors = (parsed.errors||[]).filter(e=>e.type!=='FieldMismatch');
        if(realErrors.length){ console.warn('CSV parse issues (primeros 3):', realErrors.slice(0,3)); }

        procesarFilas(parsed.data);
        renderTabla(parsed.data);
        actualizarKPIsyGraficos();
        document.getElementById('lastUpdate').textContent = 'Última actualización: ' + new Date().toLocaleTimeString();

        if(isIndicadoresActive()) renderIndicadoresChart();
      }catch(e){
        console.error(e);
        usarDatosEjemplo();
      }finally{
        mostrarLoading(false);
      }
    }

    function procesarFilas(rows){
      datosGoogleSheets._rows = rows;
      const suma = (arr)=>arr.reduce((a,b)=>a+b,0);

      // KPIs por texto del indicador (puedes migrar a Indicador_ID cuando quieras)
      const metodologias = rows.filter(r=>getIndic(r).toLowerCase().includes('metodolog')).map(getAvance);
      const instrumentos = rows.filter(r=>getIndic(r).toLowerCase().includes('instrument')).map(getAvance);
      const sello        = rows.filter(r=>getIndic(r).toLowerCase().includes('sello')).map(getAvance);
      const buenas       = rows.filter(r=>getIndic(r).toLowerCase().includes('buena')).map(getAvance);
      const productos    = rows.filter(r=>getIndic(r).toLowerCase().includes('producto')).map(getAvance);

      // Progreso general
      const porcentajes = rows.map(r=>{
        const p=getPctCumpl(r);
        if(p!=null && !Number.isNaN(p)) return Math.max(0,Math.min(100,Math.round(p)));
        const a=getAvance(r), m=getMeta(r);
        return m>0 ? Math.min(100, Math.round((a/m)*100)) : null;
      }).filter(x=>x!==null);

      datosGoogleSheets.metodologias    = suma(metodologias)||0;
      datosGoogleSheets.instrumentos    = suma(instrumentos)||0;
      datosGoogleSheets.sello           = suma(sello)||0;
      datosGoogleSheets.buenasPracticas = suma(buenas)||0;
      datosGoogleSheets.productos       = suma(productos)||0;
      datosGoogleSheets.progresoGeneral = porcentajes.length? Math.round(suma(porcentajes)/porcentajes.length) : 0;

      // Distribución por componente
      const dist={C1:0,C2:0,C3:0,C4:0};
      rows.forEach(r=>{
        const c=getComp(r);
        const n=(c.match(/\d+/)||[''])[0];
        if(n && dist['C'+n]!=null) dist['C'+n]+=1;
      });
      datosGoogleSheets._dist = dist;
    }

    function renderTabla(rows){
      const tbody=document.querySelector('#tablaDatos tbody');
      if(!tbody) return;
      tbody.innerHTML='';
      rows.forEach(r=>{
        const year=getYear(r);
        const comp=getComp(r);
        const indic=getIndic(r);
        const meta=getMeta(r);
        const avan=getAvance(r);
        const p=getPctCumpl(r);
        const perc = p!=null? Math.round(p) : (meta>0? Math.min(100, Math.round((avan/meta)*100)) : 0);
        const estado=getEstado(r);
        const compNum=(comp.match(/\d+/)||['?'])[0];

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${year||'—'}</td>
          <td><span class="component-badge">${compNum? 'C'+compNum : 'C?'}</span> ${comp||''}</td>
          <td>${indic||''}</td>
          <td>${meta||''}</td>
          <td>${avan||''}</td>
          <td>
            <div class="progress" style="height:10px;">
              <div class="progress-bar" role="progressbar" style="width:${perc}%;" aria-valuenow="${perc}" aria-valuemin="0" aria-valuemax="100">${perc}%</div>
            </div>
          </td>
          <td>${badgeEstado(estado)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function actualizarKPIsyGraficos(){
      document.getElementById('metodologiasInstitucionalizadas').textContent = `${datosGoogleSheets.metodologias}/5`;
      document.getElementById('productosComunicacionales').textContent = `${datosGoogleSheets.productos}/38`;
      document.getElementById('avanceProductos').textContent = `${Math.round((datosGoogleSheets.productos/38)*100)}% de avance`;

      const barra=document.getElementById('progresoGeneral');
      if(barra){ barra.style.width = `${datosGoogleSheets.progresoGeneral}%`; barra.setAttribute('aria-valuenow',datosGoogleSheets.progresoGeneral); }
      const texto=document.getElementById('textoProgreso');
      if(texto) texto.textContent = `Progreso general: ${datosGoogleSheets.progresoGeneral}%`;
      const mini=document.getElementById('miniProgresoActual');
      if(mini) mini.textContent = `${datosGoogleSheets.progresoGeneral}%`;

      if(componentChart && datosGoogleSheets._dist){
        const d=datosGoogleSheets._dist;
        componentChart.data.datasets[0].data = [d.C1||0,d.C2||0,d.C3||0,d.C4||0];
        componentChart.update();
      }
      if(evolutionChart) evolutionChart.update();
    }

    // ===== Indicadores: helpers y gráfico =====
    function filasFiltradas(rows){
      const year = document.getElementById('yearFilter').value;
      const componente = document.getElementById('componenteFilter').value; // "1".."4" o ""
      const estado = document.getElementById('estadoFilter').value;

      return rows.filter(r=>{
        const okYear = (year==='todos') || getYear(r)===year;
        const compText = getComp(r);
        const compNum = (compText.match(/\d+/)||[''])[0];
        const okComp = (!componente) || (compNum===componente);
        const estText = getEstado(r).toLowerCase();
        const okEstado = !estado ||
          (estado==='no-iniciado' && estText.includes('no iniciado')) ||
          (estado==='en-progreso' && (estText.includes('en progreso') || estText.includes('proceso'))) ||
          (estado==='completado' && estText.includes('completado'));
        return okYear && okComp && okEstado;
      });
    }

    function renderIndicadoresChart(){
      const canvas = document.getElementById('indicadoresChart');
      if(!canvas || !datosGoogleSheets._rows?.length) return;

      const rows = filasFiltradas(datosGoogleSheets._rows);
      const byIndic = {};
      rows.forEach(r=>{
        const key = getIndic(r);
        if(!key) return;
        const meta = getMeta(r), av = getAvance(r);
        const p = getPctCumpl(r) ?? (meta>0 ? (av/meta)*100 : null);
        if(!byIndic[key]) byIndic[key] = { sumPct:0, count:0 };
        if(p!=null && isFinite(p)) { byIndic[key].sumPct += Math.max(0, Math.min(100, p)); byIndic[key].count += 1; }
      });

      const labels = Object.keys(byIndic);
      const data = labels.map(k => {
        const {sumPct, count} = byIndic[k];
        return count ? Math.round(sumPct/count) : 0;
      });

      const config = {
        type: 'bar',
        data: { labels, datasets: [{ label: '% Avance', data, borderWidth: 1 }] },
        options: {
          responsive: true, maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, max: 100, title: { display: true, text: '% de avance' } },
            x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx)=> `${ctx.parsed.y}%` } }
          }
        }
      };

      if(indicadoresChart){
        indicadoresChart.data = config.data;
        indicadoresChart.options = config.options;
        indicadoresChart.update();
      }else{
        indicadoresChart = new Chart(canvas.getContext('2d'), config);
      }
    }

    function descargarIndicadoresCSV(){
      if(!datosGoogleSheets._rows?.length) return;
      const rows = filasFiltradas(datosGoogleSheets._rows);
      const byIndic = {};
      rows.forEach(r=>{
        const key = getIndic(r);
        if(!key) return;
        const meta = getMeta(r), av = getAvance(r);
        const p = getPctCumpl(r) ?? (meta>0 ? (av/meta)*100 : null);
        if(!byIndic[key]) byIndic[key] = { sumPct:0, count:0 };
        if(p!=null && isFinite(p)) { byIndic[key].sumPct += p; byIndic[key].count += 1; }
      });
      const rowsCSV = [['Indicador','Porcentaje_Avance']];
      Object.keys(byIndic).forEach(k=>{
        const {sumPct, count} = byIndic[k];
        const val = count ? Math.round(sumPct/count) : 0;
        rowsCSV.push([k, `${val}%`]);
      });
      const ws = XLSX.utils.aoa_to_sheet(rowsCSV);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Indicadores');
      XLSX.writeFile(wb, 'indicadores_avance.csv');
    }

    function badgeEstado(e=''){
      const v=e.toLowerCase();
      if(v.includes('complet')) return '<span class="badge bg-success">Completado</span>';
      if(v.includes('progreso')||v.includes('proceso')) return '<span class="badge bg-warning">En progreso</span>';
      if(v.includes('no')) return '<span class="badge bg-secondary">No iniciado</span>';
      return `<span class="badge bg-light text-dark">${e||'—'}</span>`;
    }

    function mostrarLoading(mostrar){
      const overlay=document.getElementById('loadingOverlay');
      if(overlay) overlay.style.display = mostrar ? 'flex':'none';
    }

    // ===== Filtros UI =====
    function aplicarFiltros(){
      const year=document.getElementById('yearFilter').value;
      const componente=document.getElementById('componenteFilter').value;
      const estado=document.getElementById('estadoFilter').value;

      const tbody=document.querySelector('#tablaDatos tbody');
      if(!tbody) return;
      tbody.querySelectorAll('tr').forEach(tr=>{
        const tds=tr.querySelectorAll('td');
        const okYear=(year==='todos') || (tds[0]?.textContent.trim()===year);
        const okComp=(!componente) || (tds[1]?.textContent.includes(`C${componente}`));
        const estText=tds[6]?.textContent.toLowerCase()||'';
        const okEstado=!estado ||
          (estado==='no-iniciado' && estText.includes('no iniciado')) ||
          (estado==='en-progreso' && estText.includes('en progreso')) ||
          (estado==='completado' && estText.includes('completado'));
        tr.style.display = (okYear && okComp && okEstado) ? '' : 'none';
      });
    }

    // ===== Exportar =====
    function descargarPDF(){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const year = document.getElementById('yearFilter').value;

      doc.setFontSize(20);
      doc.text(`Reporte ProIgualdad - Año ${year}`, 105, 15, { align:'center' });
      doc.setFontSize(12);
      doc.text("Fecha: " + new Date().toLocaleDateString(), 105, 22, { align:'center' });

      doc.setFontSize(14); doc.text("Objetivo General:", 20, 40);
      doc.setFontSize(10);
      const objetivoText = "El aporte de los actores clave en los sectores educación, empresas y medios de comunicación para el fomento de la igualdad de género y los derechos LGBTIA está fortalecido.";
      doc.text(objetivoText, 20, 50, { maxWidth: 170 });

      doc.setFontSize(14); doc.text("Avances por Componente:", 20, 80);
      doc.setFontSize(10);
      doc.text(`• Educación: ${datosGoogleSheets.metodologias}/5 metodologías institucionalizadas`, 20, 90);
      doc.text(`• Empresas: ${datosGoogleSheets.buenasPracticas}/5 buenas prácticas compartidas`, 20, 100);
      doc.text(`• Medios: ${datosGoogleSheets.productos}/38 productos comunicacionales`, 20, 110);

      doc.save(`reporte-proigualdad-${year}.pdf`);
    }

    function descargarExcel(){
      const year = document.getElementById('yearFilter').value;
      const wb = XLSX.utils.book_new();
      const datos = [
        ['Indicador','Meta','Actual','Progreso'],
        ['Metodologías educativas institucionalizadas', 5, datosGoogleSheets.metodologias, `${Math.round((datosGoogleSheets.metodologias/5)*100)}%`],
        ['Instrumentos de capacitación piloteados',     6, datosGoogleSheets.instrumentos, `${Math.round((datosGoogleSheets.instrumentos/6)*100)}%`],
        ['Instrumento de sello ampliado',               1, datosGoogleSheets.sello,          datosGoogleSheets.sello? '100%':'0%'],
        ['Buenas prácticas compartidas',                5, datosGoogleSheets.buenasPracticas,`${Math.round((datosGoogleSheets.buenasPracticas/5)*100)}%`],
        ['Productos comunicacionales',                 38, datosGoogleSheets.productos,      `${Math.round((datosGoogleSheets.productos/38)*100)}%`]
      ];
      const ws = XLSX.utils.aoa_to_sheet(datos);
      XLSX.utils.book_append_sheet(wb, ws, `Reporte ${year}`);
      XLSX.writeFile(wb, `reporte-proigualdad-${year}.xlsx`);
    }

    // Fallback si la sheet no está publicada
    function usarDatosEjemplo(){
      datosGoogleSheets = { metodologias:2, instrumentos:3, sello:1, buenasPracticas:2, productos:10, progresoGeneral:35, _rows:[] };
      document.getElementById('lastUpdate').textContent = 'Última actualización: Usando datos de ejemplo';
      actualizarKPIsyGraficos();
      if(isIndicadoresActive()) renderIndicadoresChart();
    }
  </script>
</body>
</html>
