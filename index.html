<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ProIgualdad – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- jsPDF + AutoTable + XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{ --primary:#4a3c8d; --secondary:#e5438a; --accent:#41c4b3; --light:#f8f9fa; --dark:#343a40; }
    body{ background:#f7f8fb; color:#333; }
    .navbar{ background:linear-gradient(135deg,var(--primary),#6a52b3); }
    .sidebar{ background:#fff; border-right:1px solid #e6e8ec; height:calc(100vh - 56px); position:sticky; top:56px; padding-top:14px; box-shadow:0 0 15px rgba(0,0,0,.04); }
    .sidebar .nav-link{ color:var(--dark); border-left:4px solid transparent; padding:10px 18px; margin:4px 0; transition:all .2s; }
    .sidebar .nav-link:hover,.sidebar .nav-link.active{ background:rgba(74,60,141,.08); border-left-color:var(--primary); color:var(--primary); }
    .sidebar .nav-link i{ margin-right:10px; color:var(--primary); }
    .card{ border:none; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.06); }
    .kpi-card{ border-left:4px solid var(--primary); }
    .filter-section{ background:#fff; padding:12px; border-radius:12px; margin-bottom:18px; box-shadow:0 8px 18px rgba(0,0,0,.04); }
    .dashboard-section{ display:none; }
    .dashboard-section.active{ display:block; }
    .loading-overlay{ position:fixed; inset:0; background:rgba(255,255,255,.75); display:none; align-items:center; justify-content:center; z-index:9999; }
    .badge-chip{ background:rgba(74,60,141,.1); color:#3a2c70; border-radius:999px; padding:.25rem .6rem; font-weight:500; }
    .last-update{ font-size:.85rem; color:#6c757d; }
    .empty{ color:#6c757d; padding:1rem; border:1px dashed #d9dce1; border-radius:10px; background:#fff; }
  </style>
</head>
<body>
  <!-- Loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3 mb-0">Cargando datos…</p>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-venus-double me-2"></i>ProIgualdad – Dashboard</a>
      <div class="d-flex align-items-center">
        <span class="text-light me-3" id="currentDate"></span>
        <button class="btn btn-outline-light btn-sm me-2" id="btnRefrescar">
          <i class="fa-solid fa-rotate"></i> Actualizar
        </button>
        <div class="dropdown">
          <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fa-solid fa-download"></i> Exportar
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="btnPdf"><i class="fa-solid fa-file-pdf me-2"></i>PDF</a></li>
            <li><a class="dropdown-item" href="#" id="btnExcel"><i class="fa-solid fa-file-excel me-2"></i>Excel</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 col-md-3 p-0 sidebar">
        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="resumen"><i class="fa-solid fa-chart-pie"></i>Resumen</a>
          <a class="nav-link" href="#" data-section="indicadores"><i class="fa-solid fa-chart-bar"></i>Indicadores</a>
          <a class="nav-link" href="#" data-section="cronograma"><i class="fa-solid fa-calendar-alt"></i>Cronograma</a>
          <a class="nav-link" href="#" data-section="configuracion"><i class="fa-solid fa-gear"></i>Configuración</a>
        </nav>
      </div>

      <!-- Main -->
      <div class="col-lg-10 col-md-9 mt-4">
        <!-- Filtros -->
        <div class="filter-section">
          <div class="row g-3 align-items-end">
            <div class="col-sm-4 col-md-3">
              <label class="form-label mb-1">Año de Gestión</label>
              <select class="form-select form-select-sm" id="yearFilter">
                <option value="2025">2025 (Actual)</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="todos">Todos</option>
              </select>
            </div>
            <div class="col-sm-4 col-md-3">
              <label class="form-label mb-1">Componente</label>
              <select class="form-select form-select-sm" id="componenteFilter">
                <option value="">Todos</option>
                <option value="C1">C1</option>
                <option value="C2">C2</option>
                <option value="C3">C3</option>
              </select>
            </div>
            <div class="col-sm-4 col-md-3">
              <button class="btn btn-primary btn-sm w-100" id="btnAplicar"><i class="fa-solid fa-filter me-1"></i>Aplicar filtros</button>
            </div>
            <div class="col-md-3 text-md-end">
              <span class="last-update" id="lastUpdate">Última actualización: —</span>
            </div>
          </div>
        </div>

        <!-- Resumen -->
        <div id="resumen" class="dashboard-section active">
          <h2 class="mb-3">Resumen del Proyecto</h2>
          <div class="row g-3 mb-3" id="kpisRow"></div>
          <div class="row g-3">
            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title d-flex justify-content-between align-items-center">
                    Distribución por Componente
                    <span class="badge-chip" id="filtrosChip"></span>
                  </h5>
                  <canvas id="componentChart" height="240"></canvas>
                  <div id="donutEmpty" class="empty mt-2 d-none">No hay datos para los filtros seleccionados.</div>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Consolidado por Año y Componente</h5>
                  <div class="table-responsive">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr><th>Año</th><th>Componente</th><th>Total actividades</th></tr>
                      </thead>
                      <tbody id="tablaConsolidado"></tbody>
                    </table>
                  </div>
                  <div id="consolEmpty" class="empty d-none">Sin registros.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Indicadores -->
        <div id="indicadores" class="dashboard-section">
          <h2 class="mb-3">Indicadores</h2>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Top 10 indicadores por cantidad de actividades</h5>
              <canvas id="indicatorBar" height="360"></canvas>
              <div id="indEmpty" class="empty mt-2 d-none">No hay registros para graficar.</div>
            </div>
          </div>
        </div>

        <!-- Cronograma -->
        <div id="cronograma" class="dashboard-section">
          <h2 class="mb-3">Cronograma</h2>
          <div class="card">
            <div class="card-body">
              <canvas id="monthStacked" height="280"></canvas>
              <div id="cronEmpty" class="empty mt-2 d-none">No hay datos para mostrar.</div>
            </div>
          </div>
        </div>

        <!-- Configuración -->
        <div id="configuracion" class="dashboard-section">
          <h2 class="mb-3">Configuración</h2>
          <div class="alert alert-info">
            Este dashboard lee del endpoint <code>/api/data</code>.  
            Las variables <code>SUPABASE_URL</code> y <code>SUPABASE_SERVICE_KEY</code> están en Cloudflare Pages → Settings → Environment variables.
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    if (window.Chart && Chart.defaults) Chart.defaults.devicePixelRatio = 2;

    const API_BASE = '/api/data';
    const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const PALETTE = ['#4a3c8d','#e5438a','#41c4b3','#6c757d','#28a745','#17a2b8','#fd7e14','#20c997'];

    let chartDonut, chartBarIndicators, chartStackedMonths;
    let lastJson = null;

    function showLoading(show){ document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
    function wrapWords(text, max=48){ if (!text) return ['']; const words=text.split(/\s+/); const lines=[]; let line=''; for(const w of words){ if((line+' '+w).trim().length<=max) line=(line?line+' ':'')+w; else{ if(line) lines.push(line); line=w; } } if(line) lines.push(line); return lines; }
    async function fetchJSON(url){
      const resp = await fetch(url, { headers:{ 'Accept':'application/json' }, cache: 'no-store' });
      if(!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const json = await resp.json();
      if(json && typeof json === 'object' && json.ok === true && json.data) return json.data;
      return json;
    }
    function filtrosActuales(){ const y=document.getElementById('yearFilter').value; const c=document.getElementById('componenteFilter').value; return { anio: y!=='todos'?Number(y):null, componente:c||null }; }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES',{ year:'numeric', month:'long', day:'numeric' });
      document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', e => { e.preventDefault(); document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active')); link.classList.add('active'); document.querySelectorAll('.dashboard-section').forEach(s=>s.classList.remove('active')); document.getElementById(link.getAttribute('data-section')).classList.add('active'); }));
      document.getElementById('btnAplicar').addEventListener('click', cargarDesdeAPI);
      document.getElementById('btnRefrescar').addEventListener('click', cargarDesdeAPI);
      document.getElementById('btnPdf').addEventListener('click', e => { e.preventDefault(); exportarPDF(); });
      document.getElementById('btnExcel').addEventListener('click', e => { e.preventDefault(); exportarExcel(); });
      cargarDesdeAPI();
    });

    async function cargarDesdeAPI(){
      showLoading(true);
      try{
        const { anio, componente } = filtrosActuales();
        const uRaw = new URL(API_BASE, location.origin);
        if (anio) uRaw.searchParams.set('anio', anio);
        if (componente) uRaw.searchParams.set('componente', componente);
        const dataRows = await fetchJSON(uRaw.toString());

        const mapAC=new Map(); const mapInd=new Map(); const mapMes=new Map();
        for(const r of dataRows){
          const keyAC=`${r.anio_gestion}||${r.componente}`; mapAC.set(keyAC,(mapAC.get(keyAC)||0)+1);
          const keyInd=`${r.componente}||${r.indicador||'Sin indicador'}`; mapInd.set(keyInd,(mapInd.get(keyInd)||0)+1);
          const keyMes=`${r.mes}||${r.componente}`; mapMes.set(keyMes,(mapMes.get(keyMes)||0)+1);
        }
        const byAnioComponente=[...mapAC.entries()].map(([k,t])=>{const[a,c]=k.split('||');return{anio_gestion:+a,componente:c,total:t};});
        const byIndicador=[...mapInd.entries()].map(([k,t])=>{const[c,i]=k.split('||');return{componente:c,indicador:i,total:t};});
        const byMes=[...mapMes.entries()].map(([k,t])=>{const[m,c]=k.split('||');return{mes:m,componente:c,total:t};});
        const byComponente=Object.values(dataRows.reduce((a,r)=>{a[r.componente]=a[r.componente]||{componente:r.componente,total:0};a[r.componente].total++;return a;},{}));

        lastJson={ ok:true, filters:{anio:anio||'Todos',componente:componente||'Todos'}, data:dataRows, aggregates:{byComponente,byAnioComponente,byIndicador,byMes} };

        document.getElementById('lastUpdate').textContent='Última actualización: '+new Date().toLocaleTimeString('es-ES');
        document.getElementById('filtrosChip').textContent=`Año: ${lastJson.filters.anio} · Componente: ${lastJson.filters.componente}`;
        renderKPIs(byComponente); renderDonut(byComponente); renderTablaConsolidado(byAnioComponente); renderIndicators(byIndicador); renderStackedMonths(byMes);
      }catch(err){ console.error(err); alert('No se pudieron cargar datos del servidor.'); }finally{ showLoading(false); }
    }

    // Renders...
    function renderKPIs(byC){const row=document.getElementById('kpisRow');row.innerHTML='';if(!byC||!byC.length){row.innerHTML='<div class="col-12"><div class="empty">No hay datos</div></div>';return;}byC.forEach((it,idx)=>{const col=document.createElement('div');col.className='col-12 col-md-4';col.innerHTML=`<div class="card kpi-card"><div class="card-body"><h6 class="text-muted mb-1">Componente</h6><h3 class="mb-2" style="color:${PALETTE[idx%PALETTE.length]}">${it.componente}</h3><div class="d-flex align-items-baseline gap-2"><div class="display-6 fw-bold">${it.total}</div><span class="text-muted">actividad(es)</span></div></div></div>`;row.appendChild(col);});}
    function renderDonut(byC){const labels=(byC||[]).map(d=>d.componente);const vals=(byC||[]).
