<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ProIgualdad – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <!-- jsPDF + AutoTable + XLSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    :root{ --primary:#4a3c8d; --secondary:#e5438a; --accent:#41c4b3; --light:#f8f9fa; --dark:#343a40; }
    body{ background:#f7f8fb; color:#333; }
    .navbar{ background:linear-gradient(135deg,var(--primary),#6a52b3); }
    .sidebar{ background:#fff; border-right:1px solid #e6e8ec; height:calc(100vh - 56px); position:sticky; top:56px; padding-top:14px; box-shadow:0 0 15px rgba(0,0,0,.04); }
    .sidebar .nav-link{ color:var(--dark); border-left:4px solid transparent; padding:10px 18px; margin:4px 0; transition:all .2s; }
    .sidebar .nav-link:hover,.sidebar .nav-link.active{ background:rgba(74,60,141,.08); border-left-color:var(--primary); color:var(--primary); }
    .sidebar .nav-link i{ margin-right:10px; color:var(--primary); }
    .card{ border:none; border-radius:12px; box-shadow:0 10px 24px rgba(0,0,0,.06); }
    .kpi-card{ border-left:4px solid var(--primary); }
    .filter-section{ background:#fff; padding:12px; border-radius:12px; margin-bottom:18px; box-shadow:0 8px 18px rgba(0,0,0,.04); }
    .dashboard-section{ display:none; }
    .dashboard-section.active{ display:block; }
    .loading-overlay{ position:fixed; inset:0; background:rgba(255,255,255,.75); display:none; align-items:center; justify-content:center; z-index:9999; }
    .badge-chip{ background:rgba(74,60,141,.1); color:#3a2c70; border-radius:999px; padding:.25rem .6rem; font-weight:500; }
    .last-update{ font-size:.85rem; color:#6c757d; }
    .empty{ color:#6c757d; padding:1rem; border:1px dashed #d9dce1; border-radius:10px; background:#fff; }
  </style>
</head>
<body>
  <!-- Loading -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-3 mb-0">Cargando datos…</p>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#"><i class="fa-solid fa-venus-double me-2"></i>ProIgualdad – Dashboard</a>
      <div class="d-flex align-items-center">
        <span class="text-light me-3" id="currentDate"></span>
        <button class="btn btn-outline-light btn-sm me-2" id="btnRefrescar">
          <i class="fa-solid fa-rotate"></i> Actualizar
        </button>
        <div class="dropdown">
          <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fa-solid fa-download"></i> Exportar
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#" id="btnPdf"><i class="fa-solid fa-file-pdf me-2"></i>PDF</a></li>
            <li><a class="dropdown-item" href="#" id="btnExcel"><i class="fa-solid fa-file-excel me-2"></i>Excel</a></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-lg-2 col-md-3 p-0 sidebar">
        <nav class="nav flex-column">
          <a class="nav-link active" href="#" data-section="resumen"><i class="fa-solid fa-chart-pie"></i>Resumen</a>
          <a class="nav-link" href="#" data-section="indicadores"><i class="fa-solid fa-chart-bar"></i>Indicadores</a>
          <a class="nav-link" href="#" data-section="cronograma"><i class="fa-solid fa-calendar-alt"></i>Cronograma</a>
          <a class="nav-link" href="#" data-section="configuracion"><i class="fa-solid fa-gear"></i>Configuración</a>
        </nav>
      </div>

      <!-- Main -->
      <div class="col-lg-10 col-md-9 mt-4">
        <!-- Filtros -->
        <div class="filter-section">
          <div class="row g-3 align-items-end">
            <div class="col-sm-4 col-md-3">
              <label class="form-label mb-1">Año de Gestión</label>
              <select class="form-select form-select-sm" id="yearFilter">
                <option value="2025">2025 (Actual)</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="todos">Todos</option>
              </select>
            </div>
            <div class="col-sm-4 col-md-3">
              <label class="form-label mb-1">Componente</label>
              <select class="form-select form-select-sm" id="componenteFilter">
                <option value="">Todos</option>
                <option value="C1">C1</option>
                <option value="C2">C2</option>
                <option value="C3">C3</option>
              </select>
            </div>
            <div class="col-sm-4 col-md-3">
              <button class="btn btn-primary btn-sm w-100" id="btnAplicar"><i class="fa-solid fa-filter me-1"></i>Aplicar filtros</button>
            </div>
            <div class="col-md-3 text-md-end">
              <span class="last-update" id="lastUpdate">Última actualización: —</span>
            </div>
          </div>
        </div>

        <!-- Resumen -->
        <div id="resumen" class="dashboard-section active">
          <h2 class="mb-3">Resumen del Proyecto</h2>

          <div class="row g-3 mb-3" id="kpisRow">
            <!-- KPI dinámicos por componente -->
          </div>

          <div class="row g-3">
            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title d-flex justify-content-between align-items-center">
                    Distribución por Componente
                    <span class="badge-chip" id="filtrosChip"></span>
                  </h5>
                  <canvas id="componentChart" height="240"></canvas>
                  <div id="donutEmpty" class="empty mt-2 d-none">No hay datos para los filtros seleccionados.</div>
                </div>
              </div>
            </div>

            <div class="col-lg-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Consolidado por Año y Componente</h5>
                  <div class="table-responsive">
                    <table class="table table-sm table-striped">
                      <thead>
                        <tr>
                          <th>Año</th>
                          <th>Componente</th>
                          <th>Total actividades</th>
                        </tr>
                      </thead>
                      <tbody id="tablaConsolidado"></tbody>
                    </table>
                  </div>
                  <div id="consolEmpty" class="empty d-none">Sin registros.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Indicadores -->
        <div id="indicadores" class="dashboard-section">
          <h2 class="mb-3">Indicadores</h2>
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Top 10 indicadores por cantidad de actividades</h5>
              <canvas id="indicatorBar" height="320"></canvas>
              <div id="indEmpty" class="empty mt-2 d-none">No hay registros para graficar.</div>
            </div>
          </div>
        </div>

        <!-- Cronograma -->
        <div id="cronograma" class="dashboard-section">
          <h2 class="mb-3">Cronograma (conteo de actividades por mes, apilado por componente)</h2>
          <div class="card">
            <div class="card-body">
              <canvas id="monthStacked" height="280"></canvas>
              <div id="cronEmpty" class="empty mt-2 d-none">No hay datos para mostrar.</div>
            </div>
          </div>
        </div>

        <!-- Configuración -->
        <div id="configuracion" class="dashboard-section">
          <h2 class="mb-3">Configuración</h2>
          <div class="alert alert-info">
            Este dashboard lee del endpoint <code>/api/data</code>.  
            Las variables <code>SUPABASE_URL</code> y <code>SUPABASE_SERVICE_KEY</code> están en Cloudflare Pages → Settings → Environment variables.
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ***** nitidez de charts en el PDF (y pantalla) *****
    if (window.Chart && Chart.defaults) {
      Chart.defaults.devicePixelRatio = 2; // 2x para imágenes más nítidas
    }

    // ========= CONFIG =========
    const API_BASE = '/api/data';
    const MONTHS = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const PALETTE = ['#4a3c8d','#e5438a','#41c4b3','#6c757d','#28a745','#17a2b8','#fd7e14','#20c997'];

    let chartDonut, chartBarIndicators, chartStackedMonths;
    let lastJson = null; // para exportar

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('currentDate').textContent = new Date().toLocaleDateString('es-ES', { year:'numeric', month:'long', day:'numeric' });

      // navegación entre secciones
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
          link.classList.add('active');
          const id = link.getAttribute('data-section');
          document.querySelectorAll('.dashboard-section').forEach(s => s.classList.remove('active'));
          document.getElementById(id).classList.add('active');
        });
      });

      // filtros
      document.getElementById('btnAplicar').addEventListener('click', cargarDesdeAPI);
      document.getElementById('btnRefrescar').addEventListener('click', cargarDesdeAPI);

      // export
      document.getElementById('btnPdf').addEventListener('click', () => exportarPDF());
      document.getElementById('btnExcel').addEventListener('click', exportarExcel);

      // primera carga
      cargarDesdeAPI();
    });

    function showLoading(show){ document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

    function filtrosActuales(){
      const y = document.getElementById('yearFilter').value;
      const c = document.getElementById('componenteFilter').value;
      return { anio: y !== 'todos' ? y : null, componente: c || null };
    }

    async function cargarDesdeAPI(){
      showLoading(true);
      try{
        const { anio, componente } = filtrosActuales();
        const qs = new URLSearchParams();
        if (anio) qs.set('anio', anio);
        if (componente) qs.set('componente', componente);

        const res = await fetch(`${API_BASE}${qs.toString() ? `?${qs}` : ''}`, { cache: 'no-store' });
        const json = await res.json();
        lastJson = json;

        document.getElementById('lastUpdate').textContent = 'Última actualización: ' + new Date().toLocaleTimeString('es-ES');

        // chip de filtros
        document.getElementById('filtrosChip').textContent =
          `Año: ${anio ?? 'Todos'} · Componente: ${componente || 'Todos'}`;

        // Render
        renderKPIs(json.aggregates.byComponente);
        renderDonut(json.aggregates.byComponente);
        renderTablaConsolidado(json.aggregates.byAnioComponente);
        renderIndicators(json.aggregates.byIndicador);
        renderStackedMonths(json.aggregates.byMes);

      }catch(err){
        console.error(err);
        alert('No se pudieron cargar datos del servidor.');
      }finally{
        showLoading(false);
      }
    }

    // ====== Renderizadores ======
    function renderKPIs(byComponente){
      const row = document.getElementById('kpisRow');
      row.innerHTML = '';
      if (!byComponente || byComponente.length === 0){
        row.innerHTML = '<div class="col-12"><div class="empty">No hay datos para mostrar KPI.</div></div>';
        return;
      }
      byComponente.forEach((item, idx) => {
        const col = document.createElement('div');
        col.className = 'col-12 col-md-4';
        col.innerHTML = `
          <div class="card kpi-card">
            <div class="card-body">
              <h6 class="text-muted mb-1">Componente</h6>
              <h3 class="mb-2" style="color:${PALETTE[idx%PALETTE.length]}">${item.componente}</h3>
              <div class="d-flex align-items-baseline gap-2">
                <div class="display-6 fw-bold">${item.total}</div>
                <span class="text-muted">actividad(es)</span>
              </div>
            </div>
          </div>
        `;
        row.appendChild(col);
      });
    }

    function renderDonut(byComponente){
      const labels = (byComponente||[]).map(d => d.componente || 'N/D');
      const vals   = (byComponente||[]).map(d => d.total || 0);
      const ctx = document.getElementById('componentChart')?.getContext('2d');
      const empty = document.getElementById('donutEmpty');

      if (!ctx) return;
      empty.classList.toggle('d-none', labels.length>0);

      if (chartDonut) chartDonut.destroy();
      if (labels.length === 0){ return; }

      chartDonut = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets:[{ data: vals, backgroundColor: labels.map((_,i)=> PALETTE[i%PALETTE.length]), borderWidth:0 }]},
        options: {
          responsive:true,
          plugins:{ legend:{ position:'bottom' }, tooltip:{ callbacks:{ label:(c)=> `${c.label}: ${c.raw} actividad(es)` } } }
        }
      });
    }

    function renderIndicators(byIndicador){
      const items = (byIndicador||[])
        .map(d => ({ label: `${d.componente} – ${d.indicador}`.slice(0,120), total:d.total }))
        .sort((a,b)=> b.total-a.total).slice(0,10).reverse();
      const labels = items.map(x=>x.label), vals = items.map(x=>x.total);
      const ctx = document.getElementById('indicatorBar')?.getContext('2d');
      const empty = document.getElementById('indEmpty');

      if (!ctx) return;
      empty.classList.toggle('d-none', items.length>0);

      if (chartBarIndicators) chartBarIndicators.destroy();
      if (items.length===0) return;

      chartBarIndicators = new Chart(ctx,{
        type:'bar',
        data:{ labels, datasets:[{ data:vals, backgroundColor: labels.map((_,i)=> PALETTE[i%PALETTE.length]) }] },
        options:{
          indexAxis:'y',
          responsive:true,
          scales:{ x:{ beginAtZero:true, ticks:{ precision:0 } } },
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=> ` ${c.raw} actividad(es)` } } }
        }
      });
    }

    function renderStackedMonths(byMes){
      const comps = ['C1','C2','C3'];
      const matrix = {}; MONTHS.forEach(m=> matrix[m] = { C1:0, C2:0, C3:0 });
      (byMes||[]).forEach(item => {
        if (matrix[item.mes] && matrix[item.mes][item.componente]!=null){
          matrix[item.mes][item.componente] = item.total;
        }
      });
      const datasets = comps.map((c,idx)=> ({
        label:c, data: MONTHS.map(m => matrix[m][c]),
        backgroundColor: PALETTE[idx%PALETTE.length], stack:'meses'
      }));

      const ctx = document.getElementById('monthStacked')?.getContext('2d');
      const empty = document.getElementById('cronEmpty');
      if (!ctx) return;

      const total = datasets.reduce((s,ds)=> s + ds.data.reduce((a,b)=>a+b,0), 0);
      empty.classList.toggle('d-none', total>0);

      if (chartStackedMonths) chartStackedMonths.destroy();
      if (total===0) return;

      chartStackedMonths = new Chart(ctx,{
        type:'bar',
        data:{ labels: MONTHS, datasets },
        options:{
          responsive:true,
          plugins:{ legend:{ position:'bottom' } },
          scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, ticks:{ precision:0 } } }
        }
      });
    }

    function renderTablaConsolidado(rows){
      const tb = document.getElementById('tablaConsolidado');
      const empty = document.getElementById('consolEmpty');
      tb.innerHTML = '';
      if (!rows || rows.length===0){
        empty.classList.remove('d-none');
        return;
      }
      empty.classList.add('d-none');
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.anio_gestion}</td><td>${r.componente}</td><td>${r.total}</td>`;
        tb.appendChild(tr);
      });
    }

    // ====== Exportar: incluye gráficos como imágenes ======

    // Helper: activa temporalmente la sección que contiene un canvas para poder "pintarlo"
    async function grabChartImage(canvasId, sectionId){
      const current = document.querySelector('.dashboard-section.active');
      const targetSection = document.getElementById(sectionId);
      let switched = false;

      if (targetSection && !targetSection.classList.contains('active')) {
        if (current) current.classList.remove('active');
        targetSection.classList.add('active');
        switched = true;
        // deja que el navegador pinte
        await new Promise(r => setTimeout(r, 120));
      }

      const canvas = document.getElementById(canvasId);
      let result = null;
      if (canvas && canvas.width && canvas.height) {
        result = {
          dataUrl: canvas.toDataURL('image/png'),
          w: canvas.width,
          h: canvas.height
        };
      }

      if (switched) {
        targetSection.classList.remove('active');
        if (current) current.classList.add('active');
        await new Promise(r => setTimeout(r, 0));
      }
      return result;
    }

    async function exportarPDF(){
      if (!lastJson){ alert('No hay datos para exportar.'); return; }
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });

      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 40;
      const maxW = pageW - margin*2;

      // Encabezado
      doc.setFontSize(16);
      doc.text('Reporte ProIgualdad – Dashboard', margin, 42);
      doc.setFontSize(10);
      doc.text(`Fecha: ${new Date().toLocaleString('es-ES')}`, margin, 58);
      doc.text(`Filtros: Año=${lastJson?.filters?.anio ?? 'Todos'} · Componente=${lastJson?.filters?.componente ?? 'Todos'}`, margin, 72);

      let y = 90;

      // Gráficos: donut, indicadores, cronograma (desde canvas)
      const charts = [
        { id: 'componentChart',  section: 'resumen',     title: 'Distribución por Componente' },
        { id: 'indicatorBar',    section: 'indicadores', title: 'Top 10 indicadores por cantidad de actividades' },
        { id: 'monthStacked',    section: 'cronograma',  title: 'Actividades por mes (apilado por componente)' }
      ];

      for (const ch of charts){
        const img = await grabChartImage(ch.id, ch.section);
        if (!img) continue;

        doc.setFontSize(12);
        doc.text(ch.title, margin, y);
        y += 14;

        const ratio = img.h / img.w;
        const targetW = maxW;
        const targetH = targetW * ratio;

        if (y + targetH > pageH - margin) {
          doc.addPage();
          y = margin;
        }
        doc.addImage(img.dataUrl, 'PNG', margin, y, targetW, targetH);
        y += targetH + 16;
      }

      // Tablas: consolidado y top indicadores
      const headCons = [['Año','Componente','Total']];
      const bodyCons = (lastJson.aggregates.byAnioComponente||[]).map(r => [r.anio_gestion, r.componente, r.total]);

      if (y > pageH - margin - 40) { doc.addPage(); y = margin; }
      doc.setFontSize(12);
      doc.text('Consolidado por Año y Componente', margin, y);
      y += 6;

      doc.autoTable({
        startY: y + 10,
        head: headCons,
        body: bodyCons,
        styles:{ fontSize:10, cellPadding:3 },
        margin:{ left: margin, right: margin }
      });
      y = doc.lastAutoTable.finalY + 20;

      const top = (lastJson.aggregates.byIndicador||[]).sort((a,b)=> b.total-a.total).slice(0,10);
      const headInd = [['Componente','Indicador','Total']];
      const bodyInd = top.map(r => [r.componente, String(r.indicador).slice(0,120), r.total]);

      if (y > pageH - margin - 40) { doc.addPage(); y = margin; }
      doc.text('Top 10 Indicadores', margin, y);
      doc.autoTable({
        startY: y + 10,
        head: headInd,
        body: bodyInd,
        styles:{ fontSize:9, cellPadding:3 },
        margin:{ left: margin, right: margin }
      });

      doc.save('proigualdad-dashboard.pdf');
    }

    function exportarExcel(){
      if (!lastJson){ alert('No hay datos para exportar.'); return; }
      const wb = XLSX.utils.book_new();

      // Detalle
      const detalle = (lastJson.data||[]).map(r => ({
        created_at: r.created_at, anio_gestion: r.anio_gestion, mes: r.mes,
        componente: r.componente, objetivo: r.objetivo, indicador: r.indicador,
        descripcion: r.descripcion, observaciones: r.observaciones, evidencia_url: r.evidencia_url
      }));
      const wsDetalle = XLSX.utils.json_to_sheet(detalle);
      XLSX.utils.book_append_sheet(wb, wsDetalle, 'Detalle');

      // Consolidado Año–Componente
      const cons = (lastJson.aggregates.byAnioComponente||[]).map(r => ({
        anio_gestion: r.anio_gestion, componente: r.componente, total: r.total
      }));
      const wsCons = XLSX.utils.json_to_sheet(cons);
      XLSX.utils.book_append_sheet(wb, wsCons, 'Consolidado');

      // Top Indicadores
      const top = (lastJson.aggregates.byIndicador||[]).sort((a,b)=> b.total-a.total).slice(0,20);
      const wsInd = XLSX.utils.json_to_sheet(top);
      XLSX.utils.book_append_sheet(wb, wsInd, 'Indicadores');

      XLSX.writeFile(wb, 'proigualdad-dashboard.xlsx');
    }
  </script>
</body>
</html>
