<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ProIgualdad – Formulario de Monitoreo</title>
  <style>
    :root { color-scheme: light; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; background:#0b0b0c; }

    .wrap { max-width: 1024px; margin: 0 auto; padding: 20px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }

    h1 { margin: 0 0 14px; font-size: 1.25rem; color:#111827; }

    /* Grid fluido y sin solapes */
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; }
    .col-5 { grid-column: span 5; } .col-6 { grid-column: span 6; }
    .col-7 { grid-column: span 7; } .col-8 { grid-column: span 8; }
    .col-12 { grid-column: span 12; }
    @media (max-width: 900px) { .col-3, .col-4, .col-5, .col-6, .col-7, .col-8 { grid-column: span 12; } }

    .form-group { margin-bottom: 14px; }
    label { display:block; font-size:.88rem; color:#374151; margin: 2px 0 6px; }
    input, select, textarea {
      width: 100%; font-size: .95rem; padding: .6rem .65rem;
      border: 1px solid #d1d5db; border-radius: 10px; background: #fff;
    }
    textarea[readonly] { background:#f9fafb; color:#111827; }
    .help { font-size:.82rem; color:#6b7280; margin-top:4px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .btn {
      appearance:none; border:0; cursor:pointer;
      padding:.7rem 1rem; border-radius:12px;
      font-weight:600; background:#111827; color:#fff;
    }
    .btn.secondary { background:#6b7280; }

    .status { margin-top:10px; font-size:.9rem; }
    .ok  { color:#065f46; }
    .err { color:#b91c1c; }

    /* Badges de estado (para celdas/preview) */
    .badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;border:1px solid;font-weight:600;font-size:.8rem;white-space:nowrap}
    .b-red{background:#FEE2E2;color:#991B1B;border-color:#FECACA}
    .b-yellow{background:#FEF3C7;color:#92400E;border-color:#FDE68A}
    .b-green{background:#DCFCE7;color:#065F46;border-color:#BBF7D0}
    .b-gray{background:#F3F4F6;color:#111827;border-color:#E5E7EB}
    .b-blue{background:#DBEAFE;color:#1E3A8A;border-color:#BFDBFE} /* Reprogramado */
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Formulario de Monitoreo</h1>

      <form id="formEl" aria-describedby="status">
        <div class="grid">
          <div class="col-3 form-group">
            <label for="anio_gestion">Año de gestión</label>
            <input id="anio_gestion" type="number" min="2024" max="2035" required />
          </div>

          <div class="col-3 form-group">
            <label for="mes">Mes</label>
            <select id="mes" required>
              <option value="">Seleccione…</option>
              <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option>
              <option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option>
              <option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
            </select>
            <div class="help">Se convertirá automáticamente a “01”..“12”.</div>
          </div>

          <div class="col-6 form-group">
            <label for="componente">Componente</label>
            <select id="componente" required>
              <option value="">Seleccione…</option>
              <option>COMPONENTE 1</option>
              <option>COMPONENTE 2</option>
              <option>COMPONENTE 3</option>
              <option>COMPONENTE 4</option>
            </select>
            <div class="help">Se normaliza a C1..C4 al enviar.</div>
          </div>

          <div class="col-12 form-group">
            <label for="objetivo">Objetivo del componente (autocompletado)</label>
            <textarea id="objetivo" rows="3" readonly placeholder="Se autocompleta según el componente…"></textarea>
          </div>

          <!-- Indicador + Meta del indicador (misma fila) -->
          <div class="col-8 form-group">
            <label for="indicador">Indicador</label>
            <select id="indicador" required>
              <option value="">Seleccione…</option>
            </select>
            <div class="help">Se envía el texto completo del indicador.</div>
          </div>
          <div class="col-4 form-group">
            <label for="meta">Meta del indicador</label>
            <input id="meta" type="number" step="any" placeholder="Ej.: 35, 6, 1" />
          </div>

          <div class="col-6 form-group">
            <label for="actividad_principal">Actividad principal</label>
            <input id="actividad_principal" required />
          </div>
          <div class="col-6 form-group">
            <label for="subactividad">Subactividad</label>
            <input id="subactividad" />
          </div>

          <div class="col-12 form-group">
            <label for="tarea_especifica">Tarea específica</label>
            <input id="tarea_especifica" />
          </div>

          <div class="col-12 form-group">
            <label for="descripcion">Descripción <span class="help">(requerido)</span></label>
            <textarea id="descripcion" rows="3" required placeholder="Describe la actividad, producto, alcance…"></textarea>
          </div>

          <!-- Responsable + % + Estado -->
          <div class="col-4 form-group">
            <label for="responsable">Responsable</label>
            <input id="responsable" />
          </div>
          <div class="col-4 form-group">
            <label for="porcentaje_cumplimiento">% Cumplimiento</label>
            <input id="porcentaje_cumplimiento" type="number" step="any" min="0" max="100" />
          </div>
          <div class="col-4 form-group">
            <label for="estado">Estado</label>
            <!-- Catálogo actualizado con "Reprogramado" -->
            <select id="estado" required>
              <option value="">Seleccione…</option>
              <option value="Atrasada, Interrumpida o En riesgo">Atrasada, Interrumpida o En riesgo</option>
              <option value="En proceso">En proceso</option>
              <option value="Cumplida exitosamente">Cumplida exitosamente</option>
              <option value="No puede iniciar o concluir satisfactoriamente">No puede iniciar o concluir satisfactoriamente</option>
              <option value="Reprogramado">Reprogramado</option>
            </select>
            <div id="estadoPreview" class="help" style="margin-top:6px"></div>
          </div>

          <!-- Evidencia -->
          <div class="col-12 form-group">
            <label for="evidencia_url">Evidencia (URL)</label>
            <input id="evidencia_url" type="url" placeholder="https://…" />
          </div>

          <div class="col-12 row" style="justify-content:flex-end;">
            <button type="button" class="btn secondary" id="btnReset">Limpiar</button>
            <button type="submit" class="btn">Enviar</button>
          </div>
        </div>
      </form>

      <p id="status" class="status" role="status" aria-live="polite"></p>
    </div>
  </div>

  <script>
  // ===== Catálogos oficiales =====
  const OBJETIVOS = {
    C1: 'Objetivo del Componente 1 Principios de igualdad de género y derechos LGBTIA son aplicados en la práctica docente de docentes con niños/as, adolescentes y madres/padres en las escuelas de educación primaria y secundaria y en los planes curriculares de las escuelas/unidades para la capacitación o formación continua de docentes.',
    C2: 'Objetivo del Componente 2 La aplicación de estándares de igualdad de género y derechos LGBTIA en las empresas está fortalecida.',
    C3: 'Objetivo del Componente 3 Las competencias de actores de medios de comunicación de las instituciones públicas para la elaboración de productos mediáticos y comunicacionales para el fomento de la igualdad de género y los derechos LGBTIA están fortalecidas.',
    C4: 'Objetivo del Componente 4 El equipo ProIgualdad realiza la gestión y el seguimiento a las actividades del proyecto de manera eficiente y efectiva, en forma participativa con las entidades socias e informa a GIZ, BMZ.'
  };

  const INDICADORES = {
    C1: [
      'Indicador 1.1 - 5 metodologías educativas institucionalizadas en 3 DDE',
      'Indicador 1.2 - 6 instrumentos de capacitación piloteados'
    ],
    C2: [
      'Indicador 2.1 - 1 instrumento de implementación del sello con criterios ampliados',
      'Indicador 2.2 - 5 buenas prácticas compartidas entre empresas'
    ],
    C3: [
      'Indicador 3.1 - 35 productos mediáticos para sensibilización',
      'Indicador 3.2 - 3 productos comunicacionales para servidores públicos'
    ],
    C4: [
      'Indicador 4.1 - El proyecto ha emitido los informes de seguimiento y monitoreo establecidos.',
      'Indicador 4.2 - La estructura de conducción del proyecto está en funcionamiento y se realizan las coordinaciones requeridas con las entidades socias.'
    ]
  };

  // ===== Utilidades =====
  function monthToMM(mesTxt) {
    const mapa = {
      'enero':'01','febrero':'02','marzo':'03','abril':'04','mayo':'05','junio':'06',
      'julio':'07','agosto':'08','septiembre':'09','setiembre':'09','octubre':'10','noviembre':'11','diciembre':'12'
    };
    if (!mesTxt) return '';
    return (mapa[String(mesTxt).trim().toLowerCase()] || '').padStart(2,'0');
  }
  function pascalToSnake(key) {
    return key
      .replace(/([a-z0-9])([A-Z])/g, '$1_$2')
      .replace(/([A-Z])([A-Z][a-z])/g, '$1_$2')
      .toLowerCase();
  }
  function compLabelToCode(lbl){
    const m = String(lbl||'').match(/COMPONENTE\s*([1-4])/i);
    return m ? `C${m[1]}` : String(lbl||'').toUpperCase();
  }

  // ===== Normalización de ESTADO (antiguos → nuevos) =====
  const ESTADOS_PERMITIDOS = [
    "Atrasada, Interrumpida o En riesgo",
    "En proceso",
    "Cumplida exitosamente",
    "No puede iniciar o concluir satisfactoriamente",
    "Reprogramado",
  ];

  const MAPEO_ANTIGUOS_A_NUEVOS = {
    "planificado": "No puede iniciar o concluir satisfactoriamente",
    "en ejecución": "En proceso",
    "completado": "Cumplida exitosamente",
    "retrasado": "Atrasada, Interrumpida o En riesgo",
  };

  function normalizarEstado(v) {
    if (!v) return v;
    const key = String(v).trim().toLowerCase();
    if (Object.prototype.hasOwnProperty.call(MAPEO_ANTIGUOS_A_NUEVOS, key)) {
      return MAPEO_ANTIGUOS_A_NUEVOS[key];
    }
    return ESTADOS_PERMITIDOS.includes(v) ? v : v;
  }

  // Mapa de clases para pintar celdas/badges
  const ESTADO_A_CLASE = {
    "Atrasada, Interrumpida o En riesgo": "b-red",
    "En proceso": "b-yellow",
    "Cumplida exitosamente": "b-green",
    "No puede iniciar o concluir satisfactoriamente": "b-gray",
    "Reprogramado": "b-blue",
  };

  function renderBadgeEstado(estado) {
    const clase = ESTADO_A_CLASE[estado] || "b-gray";
    return `<span class="badge ${clase}">${estado}</span>`;
  }

  function validateEstado(v) {
    return ESTADOS_PERMITIDOS.includes(v);
  }

  function normalizePayload(raw) {
    const out = {};
    Object.keys(raw).forEach(k => out[pascalToSnake(k)] = raw[k]);

    // Mes → "01".."12"
    if (raw.Mes || out.mes) out.mes = monthToMM(raw.Mes || out.mes);

    // Componente → "C1".."C4"
    if (raw.Componente || out.componente) {
      const v = String(raw.Componente || out.componente).trim().toUpperCase();
      const m = v.match(/COMPONENTE\s*([1-4])/i) || v.match(/^C([1-4])$/);
      out.componente = m ? `C${m[1]}` : v;
    }

    // Estado → normalizado (por si llega un valor antiguo)
    const estadoRaw = raw.Estado || out.estado;
    const estadoNorm = normalizarEstado(estadoRaw);
    out.estado = estadoNorm;

    return out;
  }

  // ===== Elementos =====
  const formEl = document.getElementById('formEl');
  const statusEl = document.getElementById('status');
  const selComp = document.getElementById('componente');
  const txtObjetivo = document.getElementById('objetivo');
  const selIndicador = document.getElementById('indicador');
  const anioEl = document.getElementById('anio_gestion');
  const selEstado = document.getElementById('estado');
  const estadoPreview = document.getElementById('estadoPreview');

  // Poblado seguro de opciones (evita innerHTML)
  function setOptions(selectEl, items) {
    while (selectEl.firstChild) selectEl.removeChild(selectEl.firstChild);
    const opt0 = document.createElement('option');
    opt0.value = ''; opt0.textContent = 'Seleccione…';
    selectEl.appendChild(opt0);
    (items || []).forEach(texto => {
      const opt = document.createElement('option');
      opt.value = texto;
      opt.textContent = texto;
      selectEl.appendChild(opt);
    });
  }

  // Autocompletado de objetivo + indicadores por componente
  function recargarObjetivoEIndicadores() {
    const code = compLabelToCode(selComp.value);
    txtObjetivo.value = OBJETIVOS[code] || '';
    setOptions(selIndicador, INDICADORES[code] || []);
  }
  selComp.addEventListener('change', recargarObjetivoEIndicadores);

  // Vista previa del color del estado
  function actualizarPreviewEstado() {
    const v = selEstado.value;
    if (!v) {
      estadoPreview.innerHTML = '';
      return;
    }
    estadoPreview.innerHTML = renderBadgeEstado(v);
  }
  selEstado.addEventListener('change', actualizarPreviewEstado);

  // Reset limpio
  document.getElementById('btnReset').addEventListener('click', () => {
    formEl.reset();
    recargarObjetivoEIndicadores();
    estadoPreview.innerHTML = '';
    statusEl.textContent = '';
    statusEl.className = 'status';
  });

  // ===== Envío =====
  formEl.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    statusEl.textContent = 'Enviando…';
    statusEl.className = 'status';

    const raw = {
      AnioGestion: anioEl.value,
      Mes: document.querySelector('#mes').value,
      Componente: document.querySelector('#componente').value,
      Objetivo: document.getElementById('objetivo').value,
      Indicador: document.getElementById('indicador').value, // texto completo
      Meta: document.querySelector('#meta').value,
      ActividadPrincipal: document.querySelector('#actividad_principal').value,
      Subactividad: document.querySelector('#subactividad').value,
      TareaEspecifica: document.querySelector('#tarea_especifica').value,
      Descripcion: document.querySelector('#descripcion').value,   // requerido
      Responsable: document.querySelector('#responsable').value,
      PorcentajeCumplimiento: document.querySelector('#porcentaje_cumplimiento').value,
      Estado: selEstado.value,
      EvidenciaUrl: document.querySelector('#evidencia_url').value
    };

    if (!raw.Descripcion || !raw.Descripcion.trim()) {
      statusEl.textContent = '❌ La descripción es obligatoria.';
      statusEl.className = 'status err';
      return;
    }
    if (!raw.Indicador) {
      statusEl.textContent = '❌ Debe seleccionar un indicador.';
      statusEl.className = 'status err';
      return;
    }
    if (!validateEstado(raw.Estado)) {
      statusEl.textContent = '❌ Selecciona un estado válido del catálogo vigente.';
      statusEl.className = 'status err';
      return;
    }

    const payload = normalizePayload(raw);
    if (!payload.evidencia_url) delete payload.evidencia_url;

    try {
      const res = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });
      const txt = await res.text();
      if (!res.ok) throw new Error(txt || 'Error desconocido');

      formEl.reset();
      recargarObjetivoEIndicadores();
      estadoPreview.innerHTML = '';
      statusEl.textContent = '✅ Registro enviado correctamente.';
      statusEl.className = 'status ok';
    } catch (err) {
      statusEl.textContent = '❌ Error al enviar: ' + (err?.message || String(err));
      statusEl.className = 'status err';
    }
  });

  // Inicialización
  (function init(){
    const hoy = new Date();
    anioEl.value = hoy.getFullYear();
    recargarObjetivoEIndicadores();
    actualizarPreviewEstado();
  })();
  </script>
</body>
</html>
