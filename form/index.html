<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Formulario de Reporte – ProIgualdad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    :root{ --primary:#4a3c8d; --secondary:#e5438a; }
    body{ background:#f7f8fb; }
    .navbar{ background:linear-gradient(135deg,var(--primary),#6a52b3); }
    .card{ border:none; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.06); }
    .form-label .info{ color:#6c63ff; margin-left:.35rem; cursor:pointer; }
    .counter{ font-size:.85rem; color:#6c757d; }
    .counter.over{ color:#dc3545; font-weight:600; }
    .required::after{ content:" *"; color:#dc3545; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark mb-4">
    <div class="container">
      <span class="navbar-brand">
        <i class="fa-solid fa-venus-double me-2"></i>ProIgualdad – Formulario de Reporte
      </span>
    </div>
  </nav>

  <div class="container" style="max-width:940px">
    <div id="alertHolder"></div>

    <div class="card p-4 mb-4">
      <form id="reporteForm" novalidate>
        <div class="row g-3">
          <!-- Año -->
          <div class="col-md-4">
            <label class="form-label required">Año de Gestión
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Seleccione el año de gestión sobre el que va a reportar."></i>
            </label>
            <select id="anio" class="form-select" required>
              <option value="" selected disabled>Seleccione…</option>
              <option>2025</option>
              <option>2026</option>
              <option>2027</option>
            </select>
            <div class="invalid-feedback">Seleccione un año.</div>
          </div>

          <!-- Mes -->
          <div class="col-md-4">
            <label class="form-label required">Mes
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Seleccione el mes del avance que está reportando."></i>
            </label>
            <select id="mes" class="form-select" required>
              <option value="" selected disabled>Seleccione…</option>
              <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option>
              <option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option>
              <option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
            </select>
            <div class="invalid-feedback">Seleccione un mes.</div>
          </div>

          <!-- Componente -->
          <div class="col-md-4">
            <label class="form-label required">Componente
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Elija el componente: C1, C2, C3 o Comunicación."></i>
            </label>
            <select id="componente" class="form-select" required>
              <option value="" selected disabled>Seleccione…</option>
              <option>C1: Educación</option>
              <option>C2: Empresas</option>
              <option>C3: Medios</option>
              <option>Comunicación</option>
            </select>
            <div class="invalid-feedback">Seleccione un componente.</div>
          </div>

          <!-- Objetivo dependiente -->
          <div class="col-md-6">
            <label class="form-label required">Objetivo del componente
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Seleccione el objetivo específico del componente al que corresponde la actividad."></i>
            </label>
            <select id="objetivo" class="form-select" required disabled>
              <option value="" selected disabled>Seleccione…</option>
            </select>
            <div class="invalid-feedback">Seleccione un objetivo.</div>
          </div>

          <!-- Indicador dependiente -->
          <div class="col-md-6">
            <label class="form-label required">Indicador
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Seleccione el indicador donde impacta esta actividad."></i>
            </label>
            <select id="indicador" class="form-select" required disabled>
              <option value="" selected disabled>Seleccione…</option>
            </select>
            <div class="invalid-feedback">Seleccione un indicador.</div>
          </div>

          <!-- Descripción (límite de palabras) -->
          <div class="col-12">
            <label class="form-label required">Descripción breve de la actividad realizada
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Describa brevemente la actividad realizada y su resultado. Evite detalles administrativos."></i>
            </label>
            <textarea id="descripcion" class="form-control" rows="5" placeholder="Ej.: Taller participativo con 25 docentes de la DDE X; se trabajó en... (resultados, asistentes, hallazgos breves)" required></textarea>
            <div class="d-flex justify-content-between">
              <div class="invalid-feedback d-block">Este campo es obligatorio.</div>
              <div id="descCounter" class="counter">0 / 300 palabras</div>
            </div>
          </div>

          <!-- Observaciones (opcional) -->
          <div class="col-12">
            <label class="form-label">Observaciones (opcional)
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Use esta casilla solo si requiere comentarios adicionales o sugerencias de reduccion de riesgo."></i>
            </label>
            <textarea id="observaciones" class="form-control" rows="3" placeholder="(Opcional)"></textarea>
          </div>

          <!-- Evidencia URL (opcional) -->
          <div class="col-12">
            <label class="form-label">Evidencia URL (opcional)
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Comparta aquí el enlace al repositorio o al documento de evidencia de la actividad."></i>
            </label>
            <input id="evidencia" type="url" class="form-control" placeholder="https://...">
            <div class="form-text">Debe iniciar con http:// o https://</div>
          </div>

          <div class="col-12 d-flex gap-2 mt-3">
            <button id="btnEnviar" type="submit" class="btn btn-primary px-4">
              <span class="spinner-border spinner-border-sm me-2 d-none" id="btnSpin"></span>
              Enviar reporte
            </button>
            <button type="reset" class="btn btn-outline-secondary">Limpiar</button>
          </div>
        </div>
      </form>
    </div>

    <p class="text-muted small mb-5">ProIgualdad – Sistema de Monitoreo | Formulario</p>
  </div>

  <!-- Bootstrap JS (incluye Popper, necesario para tooltips) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========= CONFIG =========
    const ENDPOINT_URL = 'https://script.google.com/macros/s/AKfycby9X4-8evChixYtN5JNzo5rVY9AWrwAA808ux9xgtg9_j_8TOb4bxqFFhPMaqcl1Svq/exec';  // <— REEMPLAZA por tu URL /exec
    const MAX_WORDS = 300;

    // Catálogo (puedes editar textos luego)
    const CATALOGO = {
      'C1: Educación': {
        '1.1 Igualdad en práctica docente': [
          '1.1.5 Metodologías educativas institucionalizadas',
          '1.1.x Instrumentos de capacitación piloteados'
        ]
      },
      'C2: Empresas': {
        '2.1 Estándares de igualdad': [
          '2.1.1 Sello ampliado',
          '2.1.2 Buenas prácticas compartidas'
        ]
      },
      'C3: Medios': {
        '3.1 Competencias comunicacionales': [
          '3.1.1 Productos comunicacionales'
        ]
      },
      'Comunicación': {
        '4.1 Estrategia comunicacional': [
          '4.1.1 Piezas y campañas publicadas'
        ]
      }
    };

    // ========= HELPERS UI =========
    const $$ = s => document.querySelector(s);
    const showAlert = (type, html) => {
      const holder = $$('#alertHolder');
      holder.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${html}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      // auto-cerrar a los 5s
      setTimeout(()=>{ holder.innerHTML=''; }, 5000);
    };
    const wordCount = t => (t.trim().length ? t.trim().split(/\s+/).length : 0);

    function safeInitTooltips(){
      try{
        if (window.bootstrap && bootstrap.Tooltip){
          document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
        }
      }catch(err){ console.warn('Tooltips no inicializados:', err); }
    }

    function cargarObjetivos(comp){
      const sel = $$('#objetivo');
      const objetivos = Object.keys(CATALOGO[comp] || {});
      sel.innerHTML = '<option value="" disabled selected>Seleccione…</option>';
      objetivos.forEach(o => sel.insertAdjacentHTML('beforeend', `<option>${o}</option>`));
      sel.disabled = objetivos.length === 0;

      // limpiar indicadores
      const indSel = $$('#indicador');
      indSel.innerHTML = '<option value="" disabled selected>Seleccione…</option>';
      indSel.disabled = true;
    }

    function cargarIndicadores(comp, obj){
      const indSel = $$('#indicador');
      const inds = (CATALOGO[comp] && CATALOGO[comp][obj]) ? CATALOGO[comp][obj] : [];
      indSel.innerHTML = '<option value="" disabled selected>Seleccione…</option>';
      inds.forEach(i => indSel.insertAdjacentHTML('beforeend', `<option>${i}</option>`));
      indSel.disabled = inds.length === 0;
    }

    async function enviar(e){
      e.preventDefault();
      const form = $$('#reporteForm');

      // Validación
      const desc = $$('#descripcion').value.trim();
      const wc = wordCount(desc);
      const url = $$('#evidencia').value.trim();
      const urlOk = (url==='' || /^https?:\/\//i.test(url));

      if (!form.checkValidity() || wc===0 || wc>MAX_WORDS || !urlOk){
        form.classList.add('was-validated');
        if (wc>MAX_WORDS) showAlert('warning', `La descripción supera el límite de <b>${MAX_WORDS}</b> palabras.`);
        if (!urlOk) showAlert('warning', `La Evidencia URL debe comenzar con http:// o https://.`);
        return;
      }

      const payload = new FormData();
      payload.append('Anio_Gestion', $$('#anio').value);
      payload.append('Mes', $$('#mes').value);
      payload.append('Componente', $$('#componente').value);
      payload.append('Objetivo', $$('#objetivo').value);
      payload.append('Indicador', $$('#indicador').value);
      payload.append('Descripcion', desc);
      payload.append('Observaciones', $$('#observaciones').value.trim());
      payload.append('Evidencia_URL', url);

      $$('#btnSpin').classList.remove('d-none');
      $$('#btnEnviar').disabled = true;

      try{
        const res = await fetch(ENDPOINT_URL, { method: 'POST', body: payload });
        // Apps Script debería devolver JSON; si no, tratamos como ok si la respuesta es "opaque"
        let ok = res.ok, data = null;
        try{ data = await res.json(); ok = ok && data?.status==='ok'; }catch(_){}
        if (!ok) throw new Error(data?.message || 'Error de servidor');
        showAlert('success', '✅ ¡Reporte enviado! Muchas gracias.');
        form.reset();
        $$('#objetivo').disabled = true; $$('#indicador').disabled = true;
        const cnt = $$('#descCounter'); cnt.textContent = `0 / ${MAX_WORDS} palabras`; cnt.classList.remove('over');
        form.classList.remove('was-validated');
      }catch(err){
        console.error(err);
        showAlert('danger', '❌ No se pudo enviar el reporte. Revise su conexión o intente nuevamente.');
      }finally{
        $$('#btnSpin').classList.add('d-none');
        $$('#btnEnviar').disabled = false;
      }
    }

    function init(){
      // Tooltips y eventos
      safeInitTooltips();

      const cnt = $$('#descCounter');
      $$('#descripcion').addEventListener('input', (e)=>{
        const wc = wordCount(e.target.value);
        cnt.textContent = `${wc} / ${MAX_WORDS} palabras`;
        cnt.classList.toggle('over', wc>MAX_WORDS);
      });

      $$('#componente').addEventListener('change', e => {
        cargarObjetivos(e.target.value);
      });

      $$('#objetivo').addEventListener('change', e => {
        cargarIndicadores($$('#componente').value, e.target.value);
      });

      $$('#reporteForm').addEventListener('submit', enviar);
    }

    document.addEventListener('DOMContentLoaded', () => {
      try { init(); }
      catch(err){
        console.error('Error inicializando el formulario:', err);
        showAlert('danger', 'Ocurrió un error cargando el formulario. Actualice la página.');
      }
    });
  </script>
</body>
</html>

              
