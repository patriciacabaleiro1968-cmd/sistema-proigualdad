<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>ProIgualdad – Formulario de Reporte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    :root{ --primary:#4a3c8d; --secondary:#e5438a; }
    body{ background:#f7f8fb; }
    .navbar{ background:linear-gradient(135deg,var(--primary),#6a52b3); }
    .card{ border:none; border-radius:14px; box-shadow:0 10px 25px rgba(0,0,0,.06); }
    .form-label .info{ color:#6c63ff; margin-left:.35rem; cursor:pointer; }
    .counter{ font-size:.85rem; color:#6c757d; }
    .counter.over{ color:#dc3545; font-weight:600; }
    .required::after{ content:" *"; color:#dc3545; }
  </style>
</head>
<body>
  <!-- Header -->
  <nav class="navbar navbar-dark mb-4">
    <div class="container">
      <span class="navbar-brand">
        <i class="fa-solid fa-venus-double me-2"></i>ProIgualdad – Formulario de Reporte
      </span>
    </div>
  </nav>

  <!-- Alerts -->
  <div class="container" style="max-width:940px">
    <div id="alertHolder"></div>

    <!-- Form -->
    <div class="card p-4 mb-4">
      <form id="reporteForm" novalidate>
        <div class="row g-3">

          <!-- Año -->
          <div class="col-md-4">
            <label class="form-label required">Año de Gestión
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Seleccione el año de gestión sobre el que va a reportar."></i>
            </label>
            <select id="anio" class="form-select" required>
              <option value="" selected disabled>Seleccione…</option>
              <option>2025</option>
              <option>2026</option>
              <option>2027</option>
            </select>
            <div class="invalid-feedback">Seleccione un año.</div>
          </div>

          <!-- Mes -->
          <div class="col-md-4">
            <label class="form-label required">Mes
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Seleccione el mes del avance que está reportando."></i>
            </label>
            <select id="mes" class="form-select" required>
              <option value="" selected disabled>Seleccione…</option>
              <option>Enero</option><option>Febrero</option><option>Marzo</option><option>Abril</option>
              <option>Mayo</option><option>Junio</option><option>Julio</option><option>Agosto</option>
              <option>Septiembre</option><option>Octubre</option><option>Noviembre</option><option>Diciembre</option>
            </select>
            <div class="invalid-feedback">Seleccione un mes.</div>
          </div>

          <!-- Componente -->
          <div class="col-md-4">
            <label class="form-label required">Componente
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Elija el componente."></i>
            </label>
            <!-- value = C1/C2/C3 para cumplir con la tabla de Supabase -->
            <select id="componente" class="form-select" required>
              <option value="" selected disabled>Seleccione…</option>

              <option value="C1" title="Principios de igualdad de género y derechos LGBTIA son aplicados en la práctica docente de docentes con niños/as, adolescentes y madres/padres en las escuelas de educación primaria y secundaria y en los planes curriculares de las escuelas/unidades para la capacitación o formación continua de docentes.">
                COMPONENTE 1: Principios de igualdad de género y derechos LGBTIA son aplicados en la práctica docente de docentes con niños/as, adolescentes y madres/padres en las escuelas de educación primaria y secundaria y en los planes curriculares de las escuelas/unidades para la capacitación o formación continua de docentes.
              </option>

              <option value="C2" title="La aplicación de estándares de igualdad de género y derechos LGBTIA en las empresas está fortalecida.">
                COMPONENTE 2: La aplicación de estándares de igualdad de género y derechos LGBTIA en las empresas está fortalecida.
              </option>

              <option value="C3" title="Las competencias de actores de medios de comunicación y de las instituciones públicas relevantes para la elaboración de productos mediáticos y comunicacionales para el fomento de la igualdad de género y los derechos LGBTIA están fortalecidas">
                COMPONENTE 3: Las competencias de actores de medios de comunicación y de las instituciones públicas relevantes para la elaboración de productos mediáticos y comunicacionales para el fomento de la igualdad de género y los derechos LGBTIA están fortalecidas
              </option>
            </select>
            <div class="invalid-feedback">Seleccione un componente.</div>
          </div>

          <!-- Objetivo dependiente -->
          <div class="col-md-6">
            <label class="form-label required">Objetivo del componente
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Seleccione el objetivo específico del componente al que corresponde la actividad."></i>
            </label>
            <select id="objetivo" class="form-select" required disabled>
              <option value="" selected disabled>Seleccione…</option>
            </select>
            <div class="invalid-feedback">Seleccione un objetivo.</div>
          </div>

          <!-- Indicador dependiente -->
          <div class="col-md-6">
            <label class="form-label required">Indicador
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Seleccione el indicador donde impacta esta actividad."></i>
            </label>
            <select id="indicador" class="form-select" required disabled>
              <option value="" selected disabled>Seleccione…</option>
            </select>
            <div class="invalid-feedback">Seleccione un indicador.</div>
          </div>

          <!-- Descripción -->
          <div class="col-12">
            <label class="form-label required">Descripción breve de la actividad realizada
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Describa brevemente la actividad realizada y su resultado. Evite detalles administrativos."></i>
            </label>
            <textarea id="descripcion" class="form-control" rows="5" placeholder="Ej.: Taller participativo con 25 docentes de la DDE X; se trabajó en... (resultados, asistentes, hallazgos breves)" required></textarea>
            <div class="d-flex justify-content-between">
              <div class="invalid-feedback d-block">Este campo es obligatorio.</div>
              <div id="descCounter" class="counter">0 / 300 palabras</div>
            </div>
          </div>

          <!-- Observaciones -->
          <div class="col-12">
            <label class="form-label">Observaciones (opcional)
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Use esta casilla solo si requiere comentarios adicionales o sugerencias de mitigación."></i>
            </label>
            <textarea id="observaciones" class="form-control" rows="3" placeholder="(Opcional)"></textarea>
          </div>

          <!-- Evidencia URL -->
          <div class="col-12">
            <label class="form-label">Evidencia URL (opcional)
              <i class="fa-solid fa-circle-info info" data-bs-toggle="tooltip" title="Comparta aquí el enlace al repositorio o al documento de evidencia de la actividad."></i>
            </label>
            <input id="evidencia" type="url" class="form-control" placeholder="https://…">
            <div class="form-text">Debe iniciar con http:// o https://</div>
          </div>

          <div class="col-12 d-flex gap-2 mt-3">
            <button id="btnEnviar" type="submit" class="btn btn-primary px-4">
              <span class="spinner-border spinner-border-sm me-2 d-none" id="btnSpin"></span>
              Enviar reporte
            </button>
            <button type="reset" class="btn btn-outline-secondary">Limpiar</button>
          </div>

        </div>
      </form>
    </div>

    <p class="text-muted small mb-5">ProIgualdad – Sistema de Monitoreo | Formulario</p>
  </div>

  <!-- Bootstrap JS (incluye Popper para tooltips) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========= CONFIG =========
    const ENDPOINT_URL = '/api/submit'; // Pages Function
    const MAX_WORDS = 300;

    // Catálogo (clave por C1/C2/C3 para cumplir con DB; texto largo visible en UI)
    const CATALOGO = {
      C1: {
        'Objetivo del Componente 1': [
          'Indicador 1.1: 5 metodologías educativas para el fomento de la igualdad de género y los derechos LGBTIA con niños/as, adolescentes y padres y madres de familia en 2 escuelas primarias y secundarias por cada uno de los 3 departamentos fueron piloteadas.',
          'Indicador 1.2: 6 instrumentos de capacitación o formación continua que fomentan la igualdad de género y los derechos LGBTIA fueron piloteadas en los planes curriculares de las escuelas/unidades para la capacitación y formación continua del personal docente.'
        ]
      },
      C2: {
        'Objetivo del Componente 2': [
          'Indicador 2.1: El pilotaje de 1 instrumento de implementación ampliado por el fomento de la igualdad de género y los derechos LGBTIQA+ en 4 empresas (2 de ellas privadas y V.R.G. 2 públicas) concluyó exitosamente en 1 empresa pública y 1 empresa privada.',
          'Indicador 2.2: 5 buenas prácticas para la aplicación de estándares de igualdad de género y derechos LGBTIQA+ son compartidas entre empresas públicas y privadas a través de una plataforma conjunta interactiva.'
        ]
      },
      C3: {
        'Objetivo del Componente 3': [
          'Indicador 3.1: 38 productos mediáticos para sensibilizar al público a nivel local, departamental y nacional en general para la igualdad de género y los derechos LGBTIA han sido elaborados por actores de medios de comunicación.',
          'Indicador 3.2: 3 productos comunicacionales para la orientación de servidores/as de instituciones públicas en la aplicación de leyes vigentes en materia de igualdad de género y derechos LGBTIA han sido elaborados por instituciones públicas relevantes.'
        ]
      }
    };

    // ========= HELPERS =========
    const $$ = s => document.querySelector(s);
    const showAlert = (type, html) => {
      const holder = $$('#alertHolder');
      holder.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${html}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
      setTimeout(()=>{ holder.innerHTML=''; }, 5000);
    };
    const wordCount = t => (t.trim().length ? t.trim().split(/\s+/).length : 0);

    function safeInitTooltips(){
      try{
        if (window.bootstrap && bootstrap.Tooltip){
          document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
        }
      }catch(err){ console.warn('Tooltips no inicializados:', err); }
    }

    function cargarObjetivos(comp){
      const sel = $$('#objetivo');
      const objetivos = Object.keys(CATALOGO[comp] || {});
      sel.innerHTML = '<option value="" disabled selected>Seleccione…</option>';
      objetivos.forEach(o => sel.insertAdjacentHTML('beforeend', `<option>${o}</option>`));
      sel.disabled = objetivos.length === 0;

      // limpiar indicadores
      const indSel = $$('#indicador');
      indSel.innerHTML = '<option value="" disabled selected>Seleccione…</option>';
      indSel.disabled = true;
    }

    function cargarIndicadores(comp, obj){
      const indSel = $$('#indicador');
      const inds = (CATALOGO[comp] && CATALOGO[comp][obj]) ? CATALOGO[comp][obj] : [];
      indSel.innerHTML = '<option value="" disabled selected>Seleccione…</option>';
      inds.forEach(i => indSel.insertAdjacentHTML('beforeend', `<option>${i}</option>`));
      indSel.disabled = inds.length === 0;
    }

    async function enviar(e){
      e.preventDefault();
      const form = $$('#reporteForm');

      // Validación
      const desc = $$('#descripcion').value.trim();
      const wc = wordCount(desc);
      const url = $$('#evidencia').value.trim();
      const urlOk = (url==='' || /^https?:\/\//i.test(url));

      if (!form.checkValidity() || wc===0 || wc>MAX_WORDS || !urlOk){
        form.classList.add('was-validated');
        if (wc>MAX_WORDS) showAlert('warning', `La descripción supera el límite de <b>${MAX_WORDS}</b> palabras.`);
        if (!urlOk) showAlert('warning', `La Evidencia URL debe comenzar con http:// o https://.`);
        return;
      }

      // Construye JSON (lo que espera /api/submit)
      const data = {
        Anio_Gestion: $$('#anio').value,
        Mes: $$('#mes').value,
        Componente: $$('#componente').value,   // C1/C2/C3
        Objetivo: $$('#objetivo').value,
        Indicador: $$('#indicador').value,
        Descripcion: desc,
        Observaciones: $$('#observaciones').value.trim(),
        Evidencia_URL: url
      };

      $$('#btnSpin').classList.remove('d-none');
      $$('#btnEnviar').disabled = true;

      try{
        const res = await fetch(ENDPOINT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const json = await res.json().catch(()=> ({}));
        if (!res.ok || json.ok === false) {
          const msg = json?.error || json?.message || 'Error de servidor';
          throw new Error(msg);
        }

        showAlert('success', '✅ ¡Reporte enviado! Muchas gracias.');
        form.reset();
        $$('#objetivo').disabled = true; $$('#indicador').disabled = true;
        const cnt = $$('#descCounter'); cnt.textContent = `0 / ${MAX_WORDS} palabras`; cnt.classList.remove('over');
        form.classList.remove('was-validated');
      }catch(err){
        console.error(err);
        showAlert('danger', '❌ No se pudo enviar el reporte. Revise su conexión o intente nuevamente.');
      }finally{
        $$('#btnSpin').classList.add('d-none');
        $$('#btnEnviar').disabled = false;
      }
    }

    function init(){
      safeInitTooltips();

      const cnt = $$('#descCounter');
      $$('#descripcion').addEventListener('input', (e)=>{
        const wc = wordCount(e.target.value);
        cnt.textContent = `${wc} / ${MAX_WORDS} palabras`;
        cnt.classList.toggle('over', wc>MAX_WORDS);
      });

      $$('#componente').addEventListener('change', e => cargarObjetivos(e.target.value));
      $$('#objetivo').addEventListener('change', e => cargarIndicadores($$('#componente').value, e.target.value));
      $$('#reporteForm').addEventListener('submit', enviar);
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
